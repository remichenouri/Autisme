# -*- coding: utf-8 -*-
"""Untitled1.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1tYyBZXlbNHUGJELlLOMJWGZVmxY346Yd
"""

import streamlit as st

import joblib
import prince

st.set_page_config(
    page_title="D√©pistage Autisme",
    page_icon="üß©",
    layout="wide",
    initial_sidebar_state="expanded"
)


import base64
import hashlib
import os
import pickle
import numpy as np
import pandas as pd
import requests
from concurrent.futures import ThreadPoolExecutor
from io import BytesIO
from PIL import Image
import streamlit.components.v1 as components
import plotly.express as px


for folder in ['data_cache', 'image_cache', 'model_cache', 'theme_cache']:
    os.makedirs(folder, exist_ok=True)


if "aq10_total" not in st.session_state:
    st.session_state.aq10_total = 0

if "aq10_responses" not in st.session_state:
    st.session_state.aq10_responses = []

def initialize_session_state():
    """Initialise l'√©tat de session pour conserver les configurations entre les recharges"""
    if 'initialized' not in st.session_state:
        st.session_state.initialized = True

        # Par d√©faut, commencer sur la page d'accueil
        default_tool = "üè† Accueil"

        # R√©cup√©rer le param√®tre de s√©lection de l'URL s'il existe
        try:
            # Pour les versions r√©centes de Streamlit (1.30.0+)
            if "selection" in st.query_params:
                selection = st.query_params["selection"]
                # Mapping entre les valeurs des liens et les options du menu
                selection_mapping = {
                    "üìù Test AQ-10": "ü§ñ Pr√©diction par IA",
                    "ü§ñ Pr√©diction par IA": "ü§ñ Pr√©diction par IA",
                    "üîç Exploration des Donn√©es": "üîç Exploration des Donn√©es"
                }

                if selection in selection_mapping:
                    st.session_state.tool_choice = selection_mapping[selection]
                else:
                    st.session_state.tool_choice = default_tool
            else:
                st.session_state.tool_choice = default_tool
        except:
            try:
                query_params = st.experimental_get_query_params()
                if "selection" in query_params:
                    selection = query_params["selection"][0]  # experimental_get_query_params retourne une liste
                    selection_mapping = {
                        "üìù Test AQ-10": "ü§ñ Pr√©diction par IA",
                        "ü§ñ Pr√©diction par IA": "ü§ñ Pr√©diction par IA",
                        "üîç Exploration des Donn√©es": "üîç Exploration des Donn√©es"
                    }

                    if selection in selection_mapping:
                        st.session_state.tool_choice = selection_mapping[selection]
                    else:
                        st.session_state.tool_choice = default_tool
                else:
                    st.session_state.tool_choice = default_tool
            except:
                st.session_state.tool_choice = default_tool

        st.session_state.data_exploration_expanded = True

def set_custom_theme():
    css_path = "theme_cache/custom_theme.css"
    os.makedirs(os.path.dirname(css_path), exist_ok=True)

    if os.path.exists(css_path):
        with open(css_path, 'r') as f:
            custom_theme = f.read()
    else:
        custom_theme = """
        <style>
        /* ================ Variables Globales Optimis√©es ================ */
        :root {
            --primary: #2c3e50 !important;
            --secondary: #3498db !important;
            --accent: #e74c3c !important;
            --background: #f8f9fa !important;
            --sidebar-bg: #ffffff !important;
            --sidebar-border: #e9ecef !important;
            --text-primary: #2c3e50 !important;
            --text-secondary: #6c757d !important;
            --sidebar-width-collapsed: 60px !important;
            --sidebar-width-expanded: 240px !important;
            --sidebar-transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            --shadow-light: 0 2px 8px rgba(0,0,0,0.08) !important;
            --shadow-medium: 0 4px 16px rgba(0,0,0,0.12) !important;
        }

        /* ================ Structure Principale ================ */
        [data-testid="stAppViewContainer"] {
            background-color: var(--background) !important;
        }

        /* ================ Sidebar Compacte et Professionnelle ================ */
        [data-testid="stSidebar"] {
            /* Dimensions optimis√©es */
            width: var(--sidebar-width-collapsed) !important;
            min-width: var(--sidebar-width-collapsed) !important;
            max-width: var(--sidebar-width-collapsed) !important;
            height: 100vh !important;
            
            /* Position fixe */
            position: fixed !important;
            left: 0 !important;
            top: 0 !important;
            z-index: 999999 !important;
            
            /* Style moderne */
            background: var(--sidebar-bg) !important;
            border-right: 1px solid var(--sidebar-border) !important;
            box-shadow: var(--shadow-light) !important;
            
            /* √âlimination du d√©filement */
            overflow: hidden !important;
            padding: 0 !important;
            
            /* Transition fluide */
            transition: var(--sidebar-transition) !important;
        }

        /* √âtat √©tendu au survol */
        [data-testid="stSidebar"]:hover {
            width: var(--sidebar-width-expanded) !important;
            min-width: var(--sidebar-width-expanded) !important;
            max-width: var(--sidebar-width-expanded) !important;
            box-shadow: var(--shadow-medium) !important;
            overflow-y: auto !important;
        }

        /* Contenu interne optimis√© */
        [data-testid="stSidebar"] > div {
            width: var(--sidebar-width-expanded) !important;
            padding: 12px 8px !important;
            height: 100vh !important;
            overflow: hidden !important;
        }

        [data-testid="stSidebar"]:hover > div {
            overflow-y: auto !important;
            padding: 16px 12px !important;
        }

        /* ================ Masquage des Barres de D√©filement ================ */
        [data-testid="stSidebar"]::-webkit-scrollbar,
        [data-testid="stSidebar"] > div::-webkit-scrollbar {
            width: 0px !important;
            background: transparent !important;
        }

        [data-testid="stSidebar"] > div {
            -ms-overflow-style: none !important;
            scrollbar-width: none !important;
        }

        /* ================ En-t√™te Professionnel ================ */
        [data-testid="stSidebar"] h2 {
            font-size: 0 !important;
            margin: 0 0 20px 0 !important;
            padding: 12px 0 !important;
            border-bottom: 1px solid var(--sidebar-border) !important;
            text-align: center !important;
            transition: all 0.3s ease !important;
            position: relative !important;
            height: 60px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        /* Ic√¥ne en mode r√©duit */
        [data-testid="stSidebar"] h2::before {
            content: "üß©" !important;
            font-size: 28px !important;
            display: block !important;
            margin: 0 !important;
        }

        /* Texte complet au survol */
        [data-testid="stSidebar"]:hover h2 {
            font-size: 1.4rem !important;
            color: var(--primary) !important;
            font-weight: 600 !important;
        }

        [data-testid="stSidebar"]:hover h2::before {
            font-size: 20px !important;
            margin-right: 8px !important;
        }

        /* ================ Options de Navigation Modernis√©es ================ */
        [data-testid="stSidebar"] .stRadio {
            padding: 0 !important;
            margin: 0 !important;
        }

        [data-testid="stSidebar"] .stRadio > div {
            display: flex !important;
            flex-direction: column !important;
            gap: 4px !important;
            padding: 0 !important;
        }

        [data-testid="stSidebar"] .stRadio label {
            display: flex !important;
            align-items: center !important;
            padding: 10px 6px !important;
            margin: 0 !important;
            border-radius: 8px !important;
            transition: all 0.3s ease !important;
            cursor: pointer !important;
            position: relative !important;
            height: 44px !important;
            overflow: hidden !important;
            background: transparent !important;
        }

        /* Ic√¥nes centr√©es en mode r√©duit */
        [data-testid="stSidebar"] .stRadio label > div:first-child {
            display: none !important;
        }

        [data-testid="stSidebar"] .stRadio label span {
            font-size: 0 !important;
            transition: all 0.3s ease !important;
            width: 100% !important;
            text-align: center !important;
            position: relative !important;
        }

        /* Affichage des ic√¥nes uniquement */
        [data-testid="stSidebar"] .stRadio label span::before {
            font-size: 22px !important;
            display: block !important;
            width: 100% !important;
            text-align: center !important;
        }

        /* Mapping des ic√¥nes pour chaque option */
        [data-testid="stSidebar"] .stRadio label:nth-child(1) span::before { content: "üè†" !important; }
        [data-testid="stSidebar"] .stRadio label:nth-child(2) span::before { content: "üîç" !important; }
        [data-testid="stSidebar"] .stRadio label:nth-child(3) span::before { content: "üß†" !important; }
        [data-testid="stSidebar"] .stRadio label:nth-child(4) span::before { content: "ü§ñ" !important; }
        [data-testid="stSidebar"] .stRadio label:nth-child(5) span::before { content: "üìö" !important; }
        [data-testid="stSidebar"] .stRadio label:nth-child(6) span::before { content: "‚ÑπÔ∏è" !important; }

        /* Mode √©tendu - affichage du texte */
        [data-testid="stSidebar"]:hover .stRadio label span {
            font-size: 14px !important;
            font-weight: 500 !important;
            text-align: left !important;
            padding-left: 12px !important;
        }

        [data-testid="stSidebar"]:hover .stRadio label span::before {
            font-size: 18px !important;
            position: absolute !important;
            left: -8px !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            width: auto !important;
        }

        /* Effets de survol */
        [data-testid="stSidebar"] .stRadio label:hover {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef) !important;
            transform: translateX(3px) !important;
            box-shadow: var(--shadow-light) !important;
        }

        /* Option s√©lectionn√©e */
        [data-testid="stSidebar"] .stRadio label[data-checked="true"] {
            background: linear-gradient(135deg, var(--secondary), #2980b9) !important;
            color: white !important;
            box-shadow: var(--shadow-medium) !important;
        }

        [data-testid="stSidebar"] .stRadio label[data-checked="true"]:hover {
            background: linear-gradient(135deg, #2980b9, var(--secondary)) !important;
            transform: translateX(5px) !important;
        }

        /* ================ Contenu Principal Adaptatif ================ */
        .main .block-container {
            margin-left: calc(var(--sidebar-width-collapsed) + 16px) !important;
            padding: 1.5rem !important;
            max-width: calc(100vw - var(--sidebar-width-collapsed) - 32px) !important;
            transition: var(--sidebar-transition) !important;
        }

        /* ================ Indicateur Visuel Subtil ================ */
        [data-testid="stSidebar"]::after {
            content: "‚Ä∫" !important;
            position: absolute !important;
            right: 6px !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            font-size: 12px !important;
            color: var(--text-secondary) !important;
            opacity: 0.5 !important;
            transition: all 0.3s ease !important;
            font-weight: bold !important;
        }

        [data-testid="stSidebar"]:hover::after {
            opacity: 0 !important;
            transform: translateY(-50%) translateX(10px) !important;
        }

        /* ================ Zone de Trigger Invisible ================ */
        .sidebar-trigger-zone {
            position: fixed !important;
            left: 0 !important;
            top: 0 !important;
            width: 10px !important;
            height: 100vh !important;
            z-index: 999998 !important;
            background: transparent !important;
        }

        /* ================ Responsive Design ================ */
        @media (max-width: 768px) {
            [data-testid="stSidebar"] {
                transform: translateX(-100%) !important;
            }
            
            [data-testid="stSidebar"]:hover {
                transform: translateX(0) !important;
                width: 280px !important;
                min-width: 280px !important;
                max-width: 280px !important;
            }
            
            .main .block-container {
                margin-left: 0 !important;
                max-width: 100vw !important;
                padding: 1rem !important;
            }
            
            .sidebar-trigger-zone {
                width: 15px !important;
            }
        }

        /* ================ Am√©liorations G√©n√©rales ================ */
        .stButton > button {
            background: linear-gradient(135deg, var(--secondary), #2980b9) !important;
            color: white !important;
            border-radius: 8px !important;
            border: none !important;
            padding: 10px 20px !important;
            font-weight: 500 !important;
            transition: all 0.3s ease !important;
            box-shadow: var(--shadow-light) !important;
        }

        .stButton > button:hover {
            transform: translateY(-2px) !important;
            box-shadow: var(--shadow-medium) !important;
            background: linear-gradient(135deg, #2980b9, var(--secondary)) !important;
        }

        /* Suppression des alertes ind√©sirables */
        .stAlert, [data-testid="stAlert"] {
            border: none !important;
            background: transparent !important;
        }
        </style>

        <script>
        // Script JavaScript optimis√©
        document.addEventListener('DOMContentLoaded', function() {
            // Cr√©er la zone de trigger si elle n'existe pas
            if (!document.querySelector('.sidebar-trigger-zone')) {
                const triggerZone = document.createElement('div');
                triggerZone.className = 'sidebar-trigger-zone';
                document.body.appendChild(triggerZone);
            }
            
            const sidebar = document.querySelector('[data-testid="stSidebar"]');
            const triggerZone = document.querySelector('.sidebar-trigger-zone');
            
            if (sidebar && triggerZone) {
                let isExpanded = false;
                let hoverTimeout;
                
                function expandSidebar() {
                    clearTimeout(hoverTimeout);
                    isExpanded = true;
                    sidebar.style.overflow = 'visible';
                }
                
                function collapseSidebar() {
                    hoverTimeout = setTimeout(() => {
                        isExpanded = false;
                        sidebar.style.overflow = 'hidden';
                    }, 200);
                }
                
                // Gestion des √©v√©nements
                [sidebar, triggerZone].forEach(element => {
                    element.addEventListener('mouseenter', expandSidebar);
                    element.addEventListener('mouseleave', collapseSidebar);
                });
                
                // Attribution des √©tats pour les options s√©lectionn√©es
                const observer = new MutationObserver(() => {
                    const radioLabels = sidebar.querySelectorAll('.stRadio label');
                    radioLabels.forEach(label => {
                        const input = label.querySelector('input[type="radio"]');
                        if (input && input.checked) {
                            label.setAttribute('data-checked', 'true');
                        } else {
                            label.setAttribute('data-checked', 'false');
                        }
                    });
                });
                
                observer.observe(sidebar, { 
                    childList: true, 
                    subtree: true,
                    attributes: true 
                });
            }
        });
        </script>
        """
        
        with open(css_path, 'w') as f:
            f.write(custom_theme)

    st.markdown(custom_theme, unsafe_allow_html=True)

def show_navigation_menu():
    """Menu de navigation optimis√© et professionnel"""
    st.markdown("## üß© Autisme - Navigation")
    st.markdown("Choisissez un outil :")

    # Options optimis√©es avec ic√¥nes coh√©rentes
    options = [
        "üè† Accueil",
        "üîç Exploration", 
        "üß† Analyse ML",
        "ü§ñ Pr√©diction par IA",
        "üìö Documentation",
        "‚ÑπÔ∏è √Ä propos"
    ]

    if 'tool_choice' not in st.session_state or st.session_state.tool_choice not in options:
        st.session_state.tool_choice = "üè† Accueil"

    current_index = options.index(st.session_state.tool_choice)

    tool_choice = st.radio(
        "",
        options,
        label_visibility="collapsed",
        index=current_index,
        key="main_navigation"
    )

    if tool_choice != st.session_state.tool_choice:
        st.session_state.tool_choice = tool_choice

    return tool_choice

set_custom_theme()

def load_visualization_libraries():
    global plt, px, go, sns

    if 'plt' not in globals():
        import matplotlib.pyplot as plt
    if 'px' not in globals():
        import plotly.express as px
    if 'go' not in globals():
        import plotly.graph_objects as go
    if 'sns' not in globals():
        import seaborn as sns

def load_ml_libraries():
    global LGBMClassifier, RandomForestClassifier, LogisticRegression, XGBClassifier
    global StandardScaler, OneHotEncoder, ColumnTransformer, Pipeline, utils
    global chi2_contingency, mannwhitneyu, prince

    if 'RandomForestClassifier' not in globals():
        from sklearn.ensemble import RandomForestClassifier
    if 'LogisticRegression' not in globals():
        from sklearn.linear_model import LogisticRegression
    if 'StandardScaler' not in globals():
        from sklearn.preprocessing import StandardScaler
    if 'OneHotEncoder' not in globals():
        from sklearn.preprocessing import OneHotEncoder
    if 'ColumnTransformer' not in globals():
        from sklearn.compose import ColumnTransformer
    if 'Pipeline' not in globals():
        from sklearn.pipeline import Pipeline
    if 'XGBClassifier' not in globals():
        from xgboost import XGBClassifier
    if 'LGBMClassifier' not in globals():
        from lightgbm import LGBMClassifier
    if 'utils' not in globals():
        from sklearn import utils
    if 'chi2_contingency' not in globals():
        from scipy.stats import chi2_contingency
    if 'mannwhitneyu' not in globals():
        from scipy.stats import mannwhitneyu
    if 'prince' not in globals():
        import prince

@st.cache_resource
def train_advanced_model(df):
    """
    Entra√Æne un mod√®le Random Forest pour la pr√©diction du TSA et retourne
    le mod√®le, le pr√©processeur et les noms des features.

    Args:
        df (pd.DataFrame): DataFrame contenant les donn√©es d'entra√Ænement

    Returns:
        tuple: (mod√®le entra√Æn√©, pr√©processeur, noms des features)
    """
    load_ml_libraries()
    load_metrics_libraries()

    try:

        if 'TSA' not in df.columns:
            st.error("La colonne 'TSA' n'existe pas dans le dataframe")
            return None, None, None

        X = df.drop(columns=['TSA'])
        y = df['TSA'].map({'Yes': 1, 'No': 0})

        numerical_cols = X.select_dtypes(include=['int64', 'float64']).columns.tolist()
        categorical_cols = X.select_dtypes(include=['object', 'category']).columns.tolist()

        preprocessor = ColumnTransformer(
            transformers=[
                ('num', StandardScaler(), numerical_cols),
                ('cat', OneHotEncoder(handle_unknown='ignore'), categorical_cols)
            ],
            remainder='passthrough',
            verbose_feature_names_out=False
        )

        rf_classifier = RandomForestClassifier(
            n_estimators=100,
            max_depth=8,
            min_samples_split=10,
            min_samples_leaf=2,
            max_features='sqrt',
            bootstrap=True,
            random_state=42,
            n_jobs=-1
        )

        pipeline = Pipeline([
            ('preprocessor', preprocessor),
            ('classifier', rf_classifier)
        ])

        X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

        pipeline.fit(X_train, y_train)

        try:
            feature_names = preprocessor.get_feature_names_out()
        except:

            feature_names = [f"feature_{i}" for i in range(pipeline.transform(X.iloc[[0]]).shape[1])]

        return pipeline, preprocessor, feature_names

    except Exception as e:
        st.error(f"Erreur lors de l'entra√Ænement du mod√®le: {str(e)}")
        return None, None, None

def get_question_text(question_number):
    """Fonction utilitaire pour obtenir le texte des questions AQ-10"""
    questions = {
        1: "Je remarque souvent de petits bruits que les autres ne remarquent pas.",
        2: "Je me concentre g√©n√©ralement davantage sur l'ensemble que sur les petits d√©tails.",
        3: "Je trouve facile de faire plusieurs choses en m√™me temps.",
        4: "S'il y a une interruption, je peux rapidement reprendre ce que je faisais.",
        5: "Je trouve facile de ¬´ lire entre les lignes ¬ª quand quelqu'un me parle.",
        6: "Je sais comment savoir si la personne qui m'√©coute commence √† s'ennuyer.",
        7: "Quand je lis une histoire, j'ai du mal √† comprendre les intentions des personnages.",
        8: "J'aime collecter des informations sur des cat√©gories de choses (par exemple : types de voitures, d'oiseaux, de trains, de plantes, etc.).",
        9: "Je trouve facile de comprendre ce que quelqu'un pense ou ressent rien qu'en regardant son visage.",
        10: "J'ai du mal √† comprendre les intentions des gens."
    }
    return questions.get(question_number, f"Question {question_number} non d√©finie")


def load_metrics_libraries():
    global accuracy_score, precision_score, recall_score, f1_score
    global roc_auc_score, confusion_matrix, classification_report
    global cross_val_score, train_test_split

    if 'accuracy_score' not in globals():
        from sklearn.metrics import accuracy_score, precision_score, recall_score, f1_score
        from sklearn.metrics import roc_auc_score, confusion_matrix, classification_report
    if 'cross_val_score' not in globals():
        from sklearn.model_selection import cross_val_score
    if 'train_test_split' not in globals():
        from sklearn.model_selection import train_test_split


@st.cache_data(ttl=86400)
def get_img_with_href(img_url, target_url, as_banner=False):
    """
    Cr√©e une image cliquable avec un lien (ou non cliquable si target_url est None, vide ou '#')
    """
    if "drive.google.com" in img_url and "/d/" in img_url:
        file_id = img_url.split("/d/")[1].split("/")[0]
        img_url = f"https://drive.google.com/uc?export=view&id={file_id}"

    cache_filename = hashlib.md5(img_url.encode()).hexdigest() + ".webp"
    cache_dir = "image_cache"
    cache_path = os.path.join(cache_dir, cache_filename)
    os.makedirs(cache_dir, exist_ok=True)

    try:
        if os.path.exists(cache_path):
            with open(cache_path, "rb") as f:
                img_data = f.read()
            img = Image.open(BytesIO(img_data))
        else:
            response = requests.get(img_url, timeout=15)
            response.raise_for_status()

            if len(response.content) == 0:
                raise Exception("Contenu vide t√©l√©charg√©")

            img = Image.open(BytesIO(response.content))

            max_width = 1200 if as_banner else 800
            if img.width > max_width:
                ratio = max_width / img.width
                new_height = int(img.height * ratio)
                img = img.resize((max_width, new_height), Image.LANCZOS)

            buffer = BytesIO()
            img.save(buffer, format="WEBP", quality=85, optimize=True)

            with open(cache_path, "wb") as f:
                f.write(buffer.getvalue())

            buffer.seek(0)
            img_data = buffer.getvalue()

        img_str = base64.b64encode(img_data).decode()

        if as_banner:
            style = 'style="width:100%;height:600px;display:block;object-fit:cover;border-radius:10px;" loading="lazy"'
        else:
            style = 'style="width:100%;height:auto;display:block;object-fit:contain;margin:0 auto;padding:0;" loading="lazy"'

        container_style = 'style="width:100%; padding:10px; background-color:white; border-radius:10px; overflow:hidden; margin-bottom:20px;"'

        # Ne pas ajouter de lien si target_url est None, vide ou '#'
        if target_url and target_url != "#":
            html_code = f'<div {container_style}><a href="{target_url}" target="_blank" style="display:block; margin:0; padding:0; line-height:0;"><img src="data:image/webp;base64,{img_str}" {style}></a></div>'
        else:
            html_code = f'<div {container_style}><img src="data:image/webp;base64,{img_str}" {style}></div>'

        return html_code
    except Exception as e:
        return f'<div style="text-align:center;padding:20px;background:#f0f2f6;border-radius:10px;"><p>Image non disponible ({str(e)})</p></div>'

@st.cache_data(ttl=86400)
def load_dataset():
    try:
        ds1_id = '1ai1QlLzn0uo-enw4IzC53jJ8qoPc845G'
        ds2_id = '1MOEhPxMNZH8LvXahvYAKiVFb9t8vAxaE'
        ds3_id = '12B-scaR0TF7TuJzelIqmlxXDjnew67-K'
        ds4_id = '1U9buLTKR_XuLWu9l3SOgvF6d9cS_YTFO'
        ds5_id = '1NdXYppnmiheLFtvrdRHDk-W-zHKO0wYp'
        final_id = '1mm6sRacDmoL941POmydQgzdVAi9lFPit'

        cache_dir = "data_cache"
        os.makedirs(cache_dir, exist_ok=True)
        final_path = os.path.join(cache_dir, "final_dataset.csv")

        if os.path.exists(final_path):
            df = pd.read_csv(final_path)
            df_ds1 = pd.read_csv(os.path.join(cache_dir, "ds1.csv"))
            df_ds2 = pd.read_csv(os.path.join(cache_dir, "ds2.csv"))
            df_ds3 = pd.read_csv(os.path.join(cache_dir, "ds3.csv"))
            df_ds4 = pd.read_csv(os.path.join(cache_dir, "ds4.csv"))
            df_ds5 = pd.read_csv(os.path.join(cache_dir, "ds5.csv"))
        else:
            url_final = f'https://drive.google.com/uc?export=download&id={final_id}'
            df = pd.read_csv(url_final)
            df.to_csv(final_path, index=False)

            with ThreadPoolExecutor(max_workers=5) as executor:
                futures = []
                urls = [
                    (f'https://drive.google.com/uc?export=download&id={ds1_id}', "ds1.csv"),
                    (f'https://drive.google.com/uc?export=download&id={ds2_id}', "ds2.csv"),
                    (f'https://drive.google.com/uc?export=download&id={ds3_id}', "ds3.csv"),
                    (f'https://drive.google.com/uc?export=download&id={ds4_id}', "ds4.csv"),
                    (f'https://drive.google.com/uc?export=download&id={ds5_id}', "ds5.csv")
                ]

                for url, filename in urls:
                    futures.append(executor.submit(download_and_save_dataset, url, os.path.join(cache_dir, filename)))

                df_ds1, df_ds2, df_ds3, df_ds4, df_ds5 = [future.result() for future in futures]

        rename_dict = {'tsa': 'TSA', 'gender': 'Genre'}
        df = df.rename(columns={k: v for k, v in rename_dict.items() if k in df.columns})

        if 'Unnamed: 0' in df.columns:
            df = df.drop(columns=['Unnamed: 0'])

        if 'TSA' in df.columns: df['TSA'] = df['TSA'].str.title()
        if 'Genre' in df.columns: df['Genre'] = df['Genre'].str.capitalize()

        aq_columns = [col for col in df.columns if col.startswith('A') and col[1:].isdigit()]
        if aq_columns:
            df['Score_A10'] = df[aq_columns].sum(axis=1)

        if 'Statut_testeur' not in df.columns:
            df['Statut_testeur'] = 'Famille'
        else:
            df['Statut_testeur'].fillna('Famille', inplace=True)

        df_stats = {
            'mean_by_tsa': df.groupby('TSA').mean(numeric_only=True) if 'TSA' in df.columns else pd.DataFrame(),
            'count_by_tsa': df.groupby('TSA').count() if 'TSA' in df.columns else pd.DataFrame(),
            'categorical_cols': df.select_dtypes(include=['object']).columns.tolist(),
            'numeric_cols': df.select_dtypes(exclude=['object']).columns.tolist()
        }

        return df, df_ds1, df_ds2, df_ds3, df_ds4, df_ds5, df_stats
    except Exception as e:
        st.error(f"Erreur lors du chargement: {str(e)}")
        return pd.DataFrame(), pd.DataFrame(), pd.DataFrame(), pd.DataFrame(), pd.DataFrame(), pd.DataFrame(), {}
        pass

def download_and_save_dataset(url, filepath):
    """Fonction auxiliaire pour t√©l√©charger et sauvegarder un dataset"""
    try:
        df = pd.read_csv(url)
        df.to_csv(filepath, index=False)
        return df
    except Exception as e:
        st.error(f"Erreur lors du t√©l√©chargement de {url}: {str(e)}")
        return pd.DataFrame()

palette = {"No": "#1f77b4", "Yes": "#ff7f0e"}

def create_mann_whitney_visualization(data, variable):
    group1 = data[data["TSA"] == "Yes"][variable].dropna()
    group2 = data[data["TSA"] == "No"][variable].dropna()

    fig = go.Figure()

    fig.add_trace(go.Box(
        y=group1,
        name="TSA",
        marker_color=palette["Yes"]
    ))

    fig.add_trace(go.Box(
        y=group2,
        name="Non-TSA",
        marker_color=palette["No"]
    ))

    fig.update_layout(
        title=f"Comparaison de {variable} entre groupes TSA et non-TSA",
        yaxis_title=variable,
        boxmode="group"
    )

    return fig

def create_distribution_chart(data, variable):
    fig = px.histogram(data, x=variable, color="TSA")
    return fig

def create_distribution_chart(data, variable):
    fig = px.histogram(data, x=variable, color="TSA",
                      barmode="group",
                      labels={"count": "Fr√©quence", "TSA": "Diagnostic TSA"},
                      color_discrete_map={"No": "#1f77b4", "Yes": "#ff7f0e"})

    fig.update_layout(
        title=f"Distribution de {variable} par diagnostic",
        xaxis_title=variable,
        yaxis_title="Fr√©quence",
        legend_title="Diagnostic TSA"
    )
    return fig

palette = {"No": "#1f77b4", "Yes": "#ff7f0e"}

def create_chi_squared_visualization(data, variable):
    cross_tab = pd.crosstab(data[variable], data["TSA"])
    data_grouped = pd.DataFrame({
        variable: [],
        "TSA": [],
        "count": [],
        "percentage": []
    })

    for cat in cross_tab.index:
        for tsa in ["No", "Yes"]:
            count = cross_tab.loc[cat, tsa]
            total = cross_tab.loc[cat].sum()
            percentage = (count / total) * 100

            data_grouped = data_grouped._append({
                variable: cat,
                "TSA": tsa,
                "count": count,
                "percentage": percentage
            }, ignore_index=True)

    fig = px.bar(data_grouped, x=variable, y="percentage", color="TSA",
                barmode="group",
                labels={"percentage": "Pourcentage (%)", "TSA": "Diagnostic TSA"},
                color_discrete_map=palette)

    fig.update_layout(
        title=f"R√©partition de {variable} par diagnostic (%)",
        xaxis_title=variable,
        yaxis_title="Pourcentage (%)",
        legend_title="Diagnostic TSA"
    )
    return fig

@st.cache_data(ttl=3600, max_entries=100)
def create_plotly_figure(df, x=None, y=None, color=None, names=None, kind='histogram', title=None):
    """Cr√©e une visualisation Plotly avec mise en cache et optimisations de performance"""

    sample_threshold = 10000
    if len(df) > sample_threshold:
        df = df.sample(sample_threshold, random_state=42)

    if color and color not in df.columns:
        color = None

    categorical_palette = {0: "#3498db", 1: "#2ecc71"}
    palette = {"Yes": "#3498db", "No": "#2ecc71", "Unknown": "#95a5a6"}
    base_layout = dict(
        height=500,
        margin=dict(l=20, r=20, t=40, b=20),
        template="simple_white",
        modebar_remove=['sendDataToCloud', 'select2d', 'lasso2d', 'autoScale2d'],
        hovermode='closest'
    )

    try:
        is_categorical_aq = x and isinstance(x, str) and x.startswith('A') and x[1:].isdigit() and len(x) <= 3

        if is_categorical_aq and kind in ['histogram', 'bar']:
            counts = df[x].value_counts().reset_index()
            counts.columns = [x, 'count']
            fig = px.bar(counts, x=x, y='count',
                        color=x,
                        color_discrete_map=categorical_palette,
                        title=f"Distribution de {x} (cat√©gorielle)")
            fig.update_layout(xaxis_title=f"Valeur de {x}", yaxis_title="Nombre d'occurrences", **base_layout)

        elif kind == 'histogram':
            nbins = 20 if len(df) < 5000 else 10
            marginal = "box" if len(df) < 3000 else None
            fig = px.histogram(df, x=x, color=color, color_discrete_map=palette,
                              marginal=marginal, nbins=nbins)
            fig.update_layout(**base_layout)

        elif kind == 'box':
            points = "all" if len(df) < 1000 else False
            fig = px.box(df, x=x, y=y, color=color, color_discrete_map=palette,
                        points=points, notched=len(df) > 200)
            fig.update_layout(**base_layout)

        elif kind == 'bar':
            fig = px.bar(df, x=x, y=y, color=color, color_discrete_map=palette)
            fig.update_layout(**base_layout)

        elif kind == 'scatter':
            opacity = 1.0 if len(df) < 500 else 0.7 if len(df) < 2000 else 0.5
            fig = px.scatter(df, x=x, y=y, color=color, color_discrete_map=palette, opacity=opacity)
            fig.update_layout(**base_layout)

        elif kind == 'pie':
            if names and isinstance(names, str) and names.startswith('A') and names[1:].isdigit() and len(names) <= 3:
                values_counts = df[names].value_counts().reset_index()
                values_counts.columns = [names, 'count']
                fig = px.pie(values_counts, values='count', names=names,
                          color=names,
                          color_discrete_map=categorical_palette,
                          title=f"R√©partition {names}")
            else:
                fig = px.pie(df, names=names, color=color, color_discrete_map=palette)
            fig.update_layout(**base_layout)

        elif kind == 'violin':
            box = len(df) < 2000
            fig = px.violin(df, x=x, y=y, color=color, color_discrete_map=palette, box=box)
            fig.update_layout(**base_layout)

        elif kind == 'count':
            fig = px.histogram(df, x=x, color=color, color_discrete_map=palette,
                            title=f"Comptage de {x}")
            fig.update_layout(yaxis_title="Nombre d'occurrences", **base_layout)

        if title:
            fig.update_layout(title=title)

        return fig
    except Exception as e:
        st.error(f"Erreur lors de la cr√©ation du graphique: {str(e)}")
        return None

def show_home_page():
    """Page d'accueil am√©lior√©e avec design moderne et responsive"""
    
    # CSS sp√©cifique corrig√© - SUPPRIMER les r√®gles conflictuelles
    st.markdown("""
    <style>
    /* Suppression des r√®gles CSS conflictuelles pour la sidebar */
    /* NE PAS red√©finir les propri√©t√©s de [data-testid="stSidebar"] */
    
    /* Suppression des barres bleues ind√©sirables */
    .stAlert, [data-testid="stAlert"] {
        border: none !important;
        background: transparent !important;
    }
    
    /* Am√©lioration du contenu principal */
    .main .block-container {
        padding-top: 1rem !important;
        max-width: 1200px !important;
    }
    
    /* Style pour les cartes d'information */
    .info-card-modern {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin: 15px 0;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        border-left: 4px solid #3498db;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .info-card-modern:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    /* Timeline responsive */
    .timeline-container {
        background-color: #f8f9fa;
        padding: 25px;
        border-radius: 15px;
        margin: 25px 0;
        overflow-x: auto;
    }
    
    .timeline-item {
        min-width: 160px;
        text-align: center;
        margin: 0 15px;
        flex-shrink: 0;
    }
    
    .timeline-year {
        background: linear-gradient(135deg, #3498db, #2ecc71);
        color: white;
        padding: 12px;
        border-radius: 8px;
        font-weight: bold;
        font-size: 0.95rem;
    }
    
    .timeline-text {
        margin-top: 12px;
        font-size: 0.9rem;
        color: #2c3e50;
        line-height: 1.4;
    }
    </style>
    """, unsafe_allow_html=True)

    # En-t√™te principal am√©lior√©
    st.markdown("""
    <div style="background: linear-gradient(90deg, #3498db, #2ecc71);
                padding: 40px 25px; border-radius: 20px; margin-bottom: 35px; text-align: center;">
        <h1 style="color: white; font-size: 2.8rem; margin-bottom: 15px;
                   text-shadow: 0 2px 4px rgba(0,0,0,0.3); font-weight: 600;">
            üß© Comprendre les Troubles du Spectre Autistique
        </h1>
        <p style="color: rgba(255,255,255,0.95); font-size: 1.3rem;
                  max-width: 800px; margin: 0 auto; line-height: 1.6;">
            Une approche moderne et scientifique pour le d√©pistage pr√©coce
        </p>
    </div>
    """, unsafe_allow_html=True)

    # Image Ghibli (conserv√©e)
    image_url = "https://drive.google.com/file/d/1fY4J-WgufGTF6AgorFOspVKkHiRKEaiW/view?usp=drive_link"
    st.markdown(get_img_with_href(image_url, None, as_banner=True), unsafe_allow_html=True)

    # Section "Qu'est-ce que l'autisme ?" am√©lior√©e
    st.markdown("""
    <div class="info-card-modern">
        <h2 style="color: #3498db; margin-bottom: 25px; font-size: 2.2rem; text-align: center;">
            üî¨ Qu'est-ce que l'autisme ?
        </h2>
        <p style="font-size: 1.2rem; line-height: 1.8; text-align: justify;
                  max-width: 900px; margin: 0 auto; color: #2c3e50;">
            Les <strong>Troubles du Spectre Autistique (TSA)</strong> sont des conditions neurod√©veloppementales
            qui affectent la fa√ßon dont une personne per√ßoit et interagit avec le monde. Caract√©ris√©s par des
            diff√©rences dans la communication sociale, les interactions sociales et par des comportements ou
            int√©r√™ts restreints et r√©p√©titifs, les TSA se manifestent sur un large spectre de sympt√¥mes et de
            niveaux de fonctionnement.
        </p>
    </div>
    """, unsafe_allow_html=True)

    # Timeline de l'√©volution am√©lior√©e
    st.markdown("""
    <h2 style="color: #3498db; margin: 45px 0 25px 0; text-align: center; font-size: 2.2rem;">
        üìÖ √âvolution de la compr√©hension de l'autisme
    </h2>
    """, unsafe_allow_html=True)

    st.markdown("""
    <div class="timeline-container">
        <div style="display: flex; justify-content: space-between; min-width: 700px;">
            <div class="timeline-item">
                <div class="timeline-year">1943</div>
                <div class="timeline-text">Leo Kanner d√©crit l'autisme infantile</div>
            </div>
            <div class="timeline-item">
                <div class="timeline-year">1980</div>
                <div class="timeline-text">L'autisme entre dans le DSM-III</div>
            </div>
            <div class="timeline-item">
                <div class="timeline-year">2013</div>
                <div class="timeline-text">Le DSM-5 introduit les TSA</div>
            </div>
            <div class="timeline-item">
                <div class="timeline-year">Aujourd'hui</div>
                <div class="timeline-text">Approche neurodiversit√©</div>
            </div>
        </div>
    </div>
    """, unsafe_allow_html=True)

   # Section "Le spectre autistique" avec HTML simplifi√©
    st.markdown("## üåà Le spectre autistique")

    st.markdown("""
    <div style="background-color: white; padding: 25px; border-radius: 15px;
               box-shadow: 0 4px 15px rgba(0,0,0,0.08); border-left: 4px solid #3498db;">
        <p style="font-size: 1.1rem; line-height: 1.7; color: #2c3e50; margin-bottom: 20px;">
            L'autisme est aujourd'hui compris comme un <strong>spectre</strong> de conditions,
            refl√©tant la grande variabilit√© des manifestations.
        </p>
        <p style="font-size: 1rem; color: #34495e; margin-bottom: 15px;">Cette conception reconna√Æt que :</p>
        <ul style="color: #34495e; padding-left: 25px; line-height: 1.6;">
            <li><strong>Chaque personne autiste</strong> pr√©sente un profil unique de forces et de d√©fis</li>
            <li><strong>Les manifestations</strong> varient en intensit√© et en expression</li>
            <li><strong>Les niveaux de soutien</strong> n√©cessaires peuvent diff√©rer consid√©rablement</li>
        </ul>
    </div>
    """, unsafe_allow_html=True)

    st.markdown("### Les trois niveaux de soutien du DSM-5 :")

    # Utiliser les colonnes Streamlit avec des composants natifs
    niveau_col1, niveau_col2, niveau_col3 = st.columns(3)

    with niveau_col1:
        st.success("**Niveau 1**\n\nN√©cessite un soutien")

    with niveau_col2:
        st.warning("**Niveau 2**\n\nN√©cessite un soutien important")

    with niveau_col3:
        st.error("**Niveau 3**\n\nN√©cessite un soutien tr√®s important")

    # Section "Contexte du projet" corrig√©e avec composants natifs
    st.header("üìä Contexte du projet")

    # Utiliser un container natif au lieu du HTML
    with st.container():
        st.write("""
        Ce projet s'inscrit dans le cadre de l'analyse des donn√©es li√©es au diagnostic des
        **Troubles du Spectre de l'Autisme (TSA)**. L'autisme n'est pas une maladie
        mais une **diff√©rence neurologique** affectant le fonctionnement du cerveau.
        """)

        st.write("""
        Notre √©quipe a travaill√© sur **5 jeux de donn√©es publics** repr√©sentant plus de
        5000 personnes de diff√©rentes origines (√âtats-Unis, Nouvelle-Z√©lande, Arabie Saoudite...)
        pour identifier les facteurs associ√©s √† la pr√©sence d'un TSA.
        """)

    # Section pr√©valence avec m√©triques natives
    st.subheader("üìà Pr√©valence de l'autisme")

    # Utiliser les composants info natifs Streamlit
    st.info("""
    **Donn√©es cl√©s sur l'autisme :**

    ‚Ä¢ **1 √† 2%** de la population mondiale est concern√©e
    ‚Ä¢ En France, environ **700 000 personnes** sont concern√©es
    ‚Ä¢ Ratio historique gar√ßons/filles d'environ **4:1** (aujourd'hui remis en question)
    """)

    # Alternative avec m√©triques si vous pr√©f√©rez
    col1, col2, col3 = st.columns(3)

    with col1:
        st.metric("Population mondiale", "1-2%", "700 000 en France")

    with col2:
        st.metric("Participants √©tudi√©s", "5000+", "Origines diverses")

    with col3:
        st.metric("Ratio historique", "4:1", "En √©volution")


    # Section "√Ä qui s'adresse ce projet" moderne
    st.markdown("""
    <h2 style="color: #3498db; margin: 45px 0 25px 0; text-align: center; font-size: 2.2rem;">
        üéØ √Ä qui s'adresse ce projet
    </h2>
    """, unsafe_allow_html=True)

    col1, col2, col3 = st.columns([1, 10, 1])

    with col2:
        # Grille 2x2 pour les publics cibles
        col_a, col_b = st.columns(2)

        with col_a:
            st.markdown("""
            <div style="background: linear-gradient(135deg, #e8f4fd, #d1ecf1);
                       border-radius: 15px; padding: 25px; margin-bottom: 20px; height: 180px;
                       border-left: 4px solid #3498db;">
                <h4 style="color: #2980b9; margin-top: 0;">üî¨ Chercheurs en sant√©</h4>
                <p style="color: #34495e; line-height: 1.6; font-size: 0.95rem;">
                    Analyse d√©taill√©e permettant d'√©tayer des hypoth√®ses scientifiques et confirmer
                    des tendances cliniques dans le domaine des TSA.
                </p>
            </div>
            """, unsafe_allow_html=True)

            st.markdown("""
            <div style="background: linear-gradient(135deg, #fff8e1, #ffecb3);
                       border-radius: 15px; padding: 25px; height: 180px;
                       border-left: 4px solid #ffa726;">
                <h4 style="color: #f57c00; margin-top: 0;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familles et particuliers</h4>
                <p style="color: #bf360c; line-height: 1.6; font-size: 0.95rem;">
                    Outils d'auto-√©valuation et d'information pour r√©pondre aux questions
                    ou suspicions de TSA et faciliter l'orientation.
                </p>
            </div>
            """, unsafe_allow_html=True)

        with col_b:
            st.markdown("""
            <div style="background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
                       border-radius: 15px; padding: 25px; margin-bottom: 20px; height: 180px;
                       border-left: 4px solid #4caf50;">
                <h4 style="color: #388e3c; margin-top: 0;">ü©∫ Professionnels de sant√©</h4>
                <p style="color: #2e7d32; line-height: 1.6; font-size: 0.95rem;">
                    R√©sultats exploitables permettant d'am√©liorer le d√©pistage et la prise
                    en charge des personnes avec TSA.
                </p>
            </div>
            """, unsafe_allow_html=True)

            st.markdown("""
            <div style="background: linear-gradient(135deg, #fce4ec, #f8bbd9);
                       border-radius: 15px; padding: 25px; height: 180px;
                       border-left: 4px solid #e91e63;">
                <h4 style="color: #c2185b; margin-top: 0;">üèõÔ∏è D√©cideurs publics</h4>
                <p style="color: #ad1457; line-height: 1.6; font-size: 0.95rem;">
                    Donn√©es et analyses pouvant informer les politiques publiques et orienter
                    les d√©cisions de financement.
                </p>
            </div>
            """, unsafe_allow_html=True)

    # Section "Accompagnement et soutien" am√©lior√©e
    st.markdown("""
    <h2 style="color: #3498db; margin: 45px 0 25px 0; text-align: center; font-size: 2.2rem;">
        ü§ù Accompagnement et soutien
    </h2>
    """, unsafe_allow_html=True)

    col1, col2, col3 = st.columns(3)

    support_cards = [
        {
            "title": "üå± Intervention pr√©coce",
            "items": ["Programmes de stimulation", "Accompagnement parental", "Th√©rapies comportementales", "Approches sensorimotrices"],
            "gradient": "linear-gradient(135deg, #3498db, #2980b9)"
        },
        {
            "title": "üìö Approches √©ducatives",
            "items": ["M√©thodes structur√©es", "Soutien √† l'inclusion", "Am√©nagements adapt√©s", "Programmes individualis√©s"],
            "gradient": "linear-gradient(135deg, #2ecc71, #27ae60)"
        },
        {
            "title": "üë• Suivi multidisciplinaire",
            "items": ["Orthophonie", "Ergoth√©rapie", "Psychomotricit√©", "Soutien psychologique"],
            "gradient": "linear-gradient(135deg, #9b59b6, #8e44ad)"
        }
    ]

    for i, (card, col) in enumerate(zip(support_cards, [col1, col2, col3])):
        with col:
            items_html = "".join([f"<li>{item}</li>" for item in card['items']])
            st.markdown(f"""
            <div style="background: {card['gradient']}; color: white;
                       padding: 25px; border-radius: 15px; height: 280px;
                       box-shadow: 0 6px 20px rgba(0,0,0,0.15);">
                <h3 style="border-bottom: 2px solid rgba(255,255,255,0.3);
                          padding-bottom: 12px; margin-bottom: 20px; font-size: 1.3rem;">
                    {card['title']}
                </h3>
                <ul style="padding-left: 20px; margin: 0; line-height: 1.8;">
                    {items_html}
                </ul>
            </div>
            """, unsafe_allow_html=True)

    # Section "Caract√©ristiques principales" am√©lior√©e
    st.markdown("""
    <h2 style="color: #3498db; margin: 45px 0 25px 0; text-align: center; font-size: 2.2rem;">
        üß† Caract√©ristiques principales
    </h2>
    """, unsafe_allow_html=True)

    col1, col2 = st.columns(2)

    with col1:
        st.markdown("""
        <div class="info-card-modern" style="border-left-color: #3498db;">
            <h3 style="color: #3498db; margin-bottom: 20px;">üí¨ Communication sociale</h3>
            <ul style="line-height: 1.8; color: #2c3e50; padding-left: 20px;">
                <li>Diff√©rences dans la communication non verbale</li>
                <li>D√©fis dans les interactions sociales</li>
                <li>Interpr√©tation litt√©rale du langage</li>
                <li>Difficult√©s avec les r√®gles sociales implicites</li>
            </ul>
        </div>
        """, unsafe_allow_html=True)

    with col2:
        st.markdown("""
        <div class="info-card-modern" style="border-left-color: #2ecc71;">
            <h3 style="color: #2ecc71; margin-bottom: 20px;">üîÑ Comportements et int√©r√™ts</h3>
            <ul style="line-height: 1.8; color: #2c3e50; padding-left: 20px;">
                <li>Int√©r√™ts sp√©cifiques et intenses</li>
                <li>Attachement aux routines</li>
                <li>Mouvements r√©p√©titifs</li>
                <li>Sensibilit√©s sensorielles particuli√®res</li>
            </ul>
        </div>
        """, unsafe_allow_html=True)

    # Section "Notre approche" finale
    st.markdown("""
    <h2 style="color: #3498db; margin: 45px 0 25px 0; text-align: center; font-size: 2.2rem;">
        üöÄ Notre approche
    </h2>
    """, unsafe_allow_html=True)

    col1, col2, col3 = st.columns([1, 10, 1])

    with col2:
        st.markdown("""
        <div style="background: linear-gradient(90deg, #3498db, #2ecc71);
                   padding: 35px; border-radius: 20px; text-align: center; color: white;
                   box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);">
            <p style="font-size: 1.3rem; max-width: 800px; margin: 0 auto; line-height: 1.7;">
                Notre plateforme combine les connaissances scientifiques actuelles et l'intelligence artificielle
                pour am√©liorer la d√©tection pr√©coce et l'accompagnement des personnes autistes,
                dans une vision respectueuse de la neurodiversit√©.
            </p>
        </div>
        """, unsafe_allow_html=True)

    # Avertissement final stylis√©
    st.markdown("""
    <div style="margin: 40px 0 30px 0; padding: 20px; border-radius: 12px;
               border-left: 4px solid #e74c3c; background: linear-gradient(135deg, #fff5f5, #ffebee);
               box-shadow: 0 4px 12px rgba(231, 76, 60, 0.1);">
        <p style="font-size: 1rem; color: #c0392b; text-align: center; margin: 0; line-height: 1.6;">
            <strong style="color: #e74c3c;">‚ö†Ô∏è Avertissement :</strong>
            Les informations pr√©sent√©es sur cette plateforme sont √† titre informatif uniquement.
            Elles ne remplacent pas l'avis m√©dical professionnel.
        </p>
    </div>
    """, unsafe_allow_html=True)


def show_data_exploration():
    # Styles CSS pour l'harmonisation avec la page d'accueil
    st.markdown(f"""
    <style>
        :root {{
            --primary: #3498db;
            --secondary: #2ecc71;
            --background: #f8f9fa;
            --text-primary: #2c3e50;
        }}

        .exploration-header {{
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            padding: 40px 25px;
            border-radius: 20px;
            margin-bottom: 35px;
            text-align: center;
        }}

        .info-card-modern {{
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 4px solid var(--primary);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }}

        .info-card-modern:hover {{
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }}

        .card-title {{
            color: var(--primary);
            border-bottom: 2px solid rgba(52, 152, 219, 0.3);
            padding-bottom: 12px;
            margin-bottom: 20px;
        }}
    </style>
    """, unsafe_allow_html=True)

    # En-t√™te harmonis√©
    st.markdown("""
    <div class="exploration-header">
        <h1 style="color: white; font-size: 2.8rem; margin-bottom: 15px;
                   text-shadow: 0 2px 4px rgba(0,0,0,0.3); font-weight: 600;">
            üîç Exploration des Donn√©es TSA
        </h1>
        <p style="color: rgba(255,255,255,0.95); font-size: 1.3rem;
                  max-width: 800px; margin: 0 auto; line-height: 1.6;">
            Analyse interactive des donn√©es de d√©pistage
        </p>
    </div>
    """, unsafe_allow_html=True)

    # Chargement des donn√©es
    df, df_ds1, df_ds2, df_ds3, df_ds4, df_ds5, df_stats = load_dataset()

    # Section Structure des Donn√©es
    with st.container():
        st.markdown("""
        <div class="info-card-modern">
            <h2 class="card-title">üìÇ Structure des Donn√©es</h2>
            <div style="margin-top: 20px;">
        """, unsafe_allow_html=True)
        
        tab_main, tab1, tab2, tab3, tab4, tab5 = st.tabs([
            "Dataset Final", "Dataset 1", "Dataset 2", "Dataset 3", "Dataset 4", "Dataset 5"
        ])
        
        with tab_main:
            st.dataframe(df.head(5), use_container_width=True)
        with tab1:
            st.dataframe(df_ds1.head(5), use_container_width=True)
        with tab2:
            st.dataframe(df_ds2.head(5), use_container_width=True)
        with tab3:
            st.dataframe(df_ds3.head(5), use_container_width=True)
        with tab4:
            st.dataframe(df_ds4.head(5), use_container_width=True)
        with tab5:
            st.dataframe(df_ds5.head(5), use_container_width=True)

        st.markdown("</div></div>", unsafe_allow_html=True)

    # Section Analyse des Valeurs Manquantes
    with st.container():
        st.markdown("""
        <div class="info-card-modern">
            <h2 class="card-title">üßº Nettoyage des Donn√©es</h2>
            <div style="margin-top: 20px;">
        """, unsafe_allow_html=True)
        
        missing_percent = (df.isnull().sum() / len(df)) * 100
        missing_info = pd.DataFrame({
            'Colonne': missing_percent.index,
            'Pourcentage': missing_percent.values
        }).sort_values('Pourcentage', ascending=False)
        
        col1, col2 = st.columns([3, 2])
        with col1:
            fig = px.bar(missing_info, x='Pourcentage', y='Colonne', orientation='h', 
                        color='Pourcentage', color_continuous_scale='Blues')
            st.plotly_chart(fig, use_container_width=True)
        with col2:
            st.dataframe(missing_info, use_container_width=True)
        
        st.markdown("</div></div>", unsafe_allow_html=True)

    # Section Statistiques
    with st.container():
        st.markdown("""
        <div class="info-card-modern">
            <h2 class="card-title">üìà M√©triques Cl√©s</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
        """, unsafe_allow_html=True)
        
        col1, col2, col3 = st.columns(3)
        with col1:
            st.metric("Nombre total d'√©chantillons", len(df))
        with col2:
            st.metric("√Çge moyen", f"{df['Age'].mean():.1f} ans")
        with col3:
            tsa_percent = df['TSA'].value_counts(normalize=True).get('Yes', 0) * 100
            st.metric("Pr√©valence TSA", f"{tsa_percent:.1f}%")
        
        st.markdown("</div></div>", unsafe_allow_html=True)

    # Personnalisation des graphiques
    px.defaults.color_discrete_sequence = ["#3498db", "#2ecc71"]
    px.defaults.color_continuous_scale = px.colors.sequential.Blues

    # Section Visualisations interactives
    with st.container():
        st.markdown("""
        <div class="info-card-modern">
            <h2 class="card-title">üìä Analyse Interactive</h2>
            <div style="margin-top: 20px;">
        """, unsafe_allow_html=True)
        
        selected_var = st.selectbox("Choisir une variable √† analyser", df.columns.drop('TSA'))
        
        col1, col2 = st.columns(2)
        with col1:
            fig = px.histogram(df, x=selected_var, color='TSA', barmode='group')
            st.plotly_chart(fig, use_container_width=True)
        with col2:
            stats = df[selected_var].describe().to_frame().T
            st.dataframe(stats, use_container_width=True)
        
        st.markdown("</div></div>", unsafe_allow_html=True)



    with st.expander("üìà Statistiques du Dataset Final", expanded=True):
        st.subheader("Statistiques Descriptives")
        tab1, tab2 = st.tabs(["Num√©riques", "Cat√©gorielles"])
        with tab1:
            st.write(df.describe())
        with tab2:
            categorical_stats = df.select_dtypes(include=['object']).describe().T
            st.dataframe(categorical_stats)

    with st.expander("üìä Distribution des Variables Cl√©s", expanded=True):
        st.markdown("""
        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="color: #2c3e50; margin-top: 0;">Distribution des Variables Cl√©s</h3>
            <p style="color: #7f8c8d;">Analyse interactive des distributions par variable.</p>
        </div>
        """, unsafe_allow_html=True)

        # Dictionnaire de commentaires pour les variables
        variable_comments = {
            'A1': "Variable li√©e au questionnaire AQ-10 : √©value la capacit√© √† remarquer des d√©tails que d'autres pourraient manquer.",
            'A2': "Variable li√©e au questionnaire AQ-10 : √©value la capacit√© √† imaginer des histoires.",
            'A3': "Variable li√©e au questionnaire AQ-10 : √©value la pr√©f√©rence pour la socialisation vs activit√©s solitaires.",
            'A4': "Variable li√©e au questionnaire AQ-10 : √©value la tendance √† se concentrer sur un sujet sp√©cifique.",
            'A5': "Variable li√©e au questionnaire AQ-10 : √©value l'attention aux d√©tails num√©riques et dates.",
            'A6': "Variable li√©e au questionnaire AQ-10 : √©value la capacit√© √† comprendre les intentions des autres.",
            'A7': "Variable li√©e au questionnaire AQ-10 : √©value la capacit√© √† r√©agir de mani√®re appropri√©e socialement.",
            'A8': "Variable li√©e au questionnaire AQ-10 : √©value les interactions sociales en groupe.",
            'A9': "Variable li√©e au questionnaire AQ-10 : √©value la reconnaissance des √©motions chez autrui.",
            'A10': "Variable li√©e au questionnaire AQ-10 : √©value la capacit√© √† g√©rer plusieurs t√¢ches simultan√©ment.",
            'Jaunisse': "Indique si l'individu a eu une jaunisse √† la naissance, facteur potentiellement associ√© au risque d'autisme.",
            'Statut_testeur': "Indique la relation entre le testeur et la personne √©valu√©e (Famille, Professionnel de sant√©, Individu, etc.).",
        }

        # D√©finition par d√©faut pour les variables sans commentaire sp√©cifique
        default_comment = "Distribution de la variable dans l'ensemble du dataset."

        all_columns = [col for col in df.columns if col != 'TSA']
        analysis_var = st.selectbox("Choisir une variable √† analyser", all_columns, key="analysis_var_in_exploration")

        # Afficher le commentaire pour la variable s√©lectionn√©e
        comment = variable_comments.get(analysis_var, default_comment)
        st.info(comment)

        col1, col2 = st.columns(2)
        with col1:
            color_var = None  # Ne pas utiliser la coloration par TSA
            if analysis_var == 'Jaunisse':
                fig = px.histogram(df, x='Jaunisse',
                                   title=f"Distribution de la jaunisse dans le dataset")
                st.plotly_chart(fig, use_container_width=True)
            else:
                is_categorical_aq = analysis_var.startswith('A') and analysis_var[1:].isdigit() and len(analysis_var) <= 3
                if is_categorical_aq:
                    fig = create_plotly_figure(df, x=analysis_var, color=color_var, kind='bar', title=f"Distribution de {analysis_var} (cat√©gorielle)")
                else:
                    fig = create_plotly_figure(df, x=analysis_var, color=color_var, kind='histogram', title=f"Distribution de {analysis_var}")
                if fig:
                    st.plotly_chart(fig, use_container_width=True)
        with col2:
            stats = df[analysis_var].describe().to_frame().T
            st.dataframe(stats, use_container_width=True)


    with st.expander("üìù Analyse des R√©ponses au Questionnaire AQ-10", expanded=True):
        st.subheader("Analyse des R√©ponses au Questionnaire AQ-10")
        question_tabs = st.tabs([f"Q{i+1}" for i in range(10)])
        for i, tab in enumerate(question_tabs):
            with tab:
                col1, col2 = st.columns([2,3])
                with col1:
                    st.write(f"**Question A{i+1} :**")
                    st.markdown("> " + get_question_text(i+1))
                with col2:
                    try:
                        values_counts = df[f'A{i+1}'].value_counts().reset_index()
                        values_counts.columns = [f'A{i+1}', 'count']
                        color_discrete_map = {0: "#2ecc71", 1: "#3498db"}
                        fig = px.pie(
                            values_counts,
                            values='count',
                            names=f'A{i+1}',
                            color=f'A{i+1}',
                            color_discrete_map=color_discrete_map,
                            title=f"R√©partition des r√©ponses A{i+1}"
                        )
                        st.plotly_chart(fig, use_container_width=True)
                    except Exception as e:
                        st.error(f"Erreur lors de la cr√©ation du graphique: {str(e)}")

    with st.expander("‚öôÔ∏è Cr√©ation de Variables Composites", expanded=True):
        st.subheader("Cr√©ation de Variables Composites")
        col1, col2 = st.columns(2)
        with col1:
            st.write("**Score A10 :**")
            st.markdown("""
            $$
            \\text{Score\\_A10} = \\sum_{i=1}^{10} A_i
            $$
            """)
            if 'TSA' in df.columns:
                yes_mean = df[df['TSA'] == 'Yes']['Score_A10'].mean()
                no_mean = df[df['TSA'] == 'No']['Score_A10'].mean()
                st.metric("Score Moyen (TSA)", f"{yes_mean:.1f} ¬± {df[df['TSA'] == 'Yes']['Score_A10'].std():.1f}")
                st.metric("Score Moyen (Non-TSA)", f"{no_mean:.1f} ¬± {df[df['TSA'] == 'No']['Score_A10'].std():.1f}")
            else:
                overall_mean = df['Score_A10'].mean()
                st.metric("Score Moyen", f"{overall_mean:.1f} ¬± {df['Score_A10'].std():.1f}")
        with col2:
            color_var = 'TSA' if 'TSA' in df.columns else None
            fig = create_plotly_figure(df, y='Score_A10', color=color_var, kind='violin', title="Distribution des Scores")
            if fig:
                st.plotly_chart(fig, use_container_width=True)

    with st.expander("üîó Matrice de Corr√©lation", expanded=True):
        try:
            df_corr = df.copy()
            if 'Jaunisse' in df_corr.columns:
                df_corr = df_corr.drop(columns=['Jaunisse'])
            if 'TSA' in df_corr.columns:
                df_corr['TSA_num'] = df_corr['TSA'].map({'Yes': 1, 'No': 0})
            categorical_cols = df_corr.select_dtypes(include=['object']).columns
            if not categorical_cols.empty:
                from sklearn.preprocessing import OneHotEncoder
                ohe = OneHotEncoder(sparse_output=False, drop='first')
                encoded_data = ohe.fit_transform(df_corr[categorical_cols])
                feature_names = ohe.get_feature_names_out(categorical_cols)
                encoded_df = pd.DataFrame(encoded_data, columns=feature_names)
                numeric_df = df_corr.select_dtypes(exclude=['object']).reset_index(drop=True)
                df_corr_processed = pd.concat([numeric_df, encoded_df], axis=1)
                corr_matrix = df_corr_processed.corr(numeric_only=True)
            else:
                df_corr_processed = df_corr.select_dtypes(exclude=['object'])
                corr_matrix = df_corr_processed.corr(numeric_only=True)

            mask = np.triu(np.ones_like(corr_matrix, dtype=bool))
            fig, ax = plt.subplots(figsize=(14, 12))
            cmap = sns.diverging_palette(200, 120, as_cmap=True)
            sns.heatmap(
                corr_matrix,
                mask=mask,
                cmap=cmap,
                vmax=1.0,
                vmin=-1.0,
                center=0,
                square=True,
                linewidths=0.8,
                fmt='.2f',
                annot=True,
                annot_kws={"size": 9, "weight": "bold"},
                cbar_kws={"shrink": 0.8, "label": "Coefficient de corr√©lation"}
            )
            plt.title("Matrice de corr√©lation des variables", fontsize=16, pad=20)
            plt.xticks(rotation=45, ha='right', fontsize=9)
            plt.yticks(fontsize=9)
            plt.tight_layout()
            st.pyplot(fig)
        except Exception as e:
            st.error(f"Erreur lors du calcul de la matrice de corr√©lation: {str(e)}")


    with st.expander("üß™ Tests Statistiques", expanded=True):
        st.markdown("""
        <div style="background-color: #f0f7ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h4 style="color: #3498db; margin-top: 0;">Tests d'association statistique</h4>
            <p>√âvaluation des relations entre variables et diagnostic TSA</p>
        </div>
        """, unsafe_allow_html=True)

        test_type = st.radio(
            "Choisir le type de test:",
            ["Chi-carr√© (variables cat√©gorielles)", "Mann-Whitney (variables num√©riques)"],
            key="stat_test_type"
        )

        if test_type == "Chi-carr√© (variables cat√©gorielles)":
            from scipy.stats import chi2_contingency

            st.markdown("""
            **Test d'ind√©pendance du Chi-carr√© :** √âvalue si deux variables cat√©gorielles sont ind√©pendantes.
            Un p-value < 0.05 sugg√®re une relation significative.
            """)

            df = df.copy()
            categorical_cols = df.select_dtypes(include=['object']).columns.tolist()
            aq_columns = [col for col in df.columns if col.startswith('A') and col[1:].isdigit()]
            categorical_cols.extend([col for col in aq_columns if col not in categorical_cols])

            if 'TSA' in categorical_cols:
                categorical_cols.remove('TSA')

                if categorical_cols:
                    cat_var = st.selectbox(
                        "S√©lectionner une variable cat√©gorielle:",
                        categorical_cols,
                        key="chi2_var_selector"
                    )

                    try:
                        contingency_table = pd.crosstab(df[cat_var], df['TSA'])
                        chi2_stat, p_val, dof, expected = chi2_contingency(contingency_table)

                        # R√©duction de la largeur avec colonnes optimis√©es
                        col1, col2, col3 = st.columns([2, 2, 3])

                        with col1:
                            st.markdown("### Table de contingence")
                            st.dataframe(contingency_table, use_container_width=True)

                        with col2:
                            st.markdown("### R√©sultats du test")
                            st.metric("Statistique œá¬≤", f"{chi2_stat:.3f}")
                            st.metric("p-value", f"{p_val:.5f}")
                            st.metric("Degr√©s de libert√©", dof)

                            if p_val < 0.05:
                                st.success("**Significatif** (p < 0.05)")
                            else:
                                st.info("**Non significatif** (p > 0.05)")

                        with col3:
                            # Graphique plus compact
                            contingency_percent = contingency_table.div(contingency_table.sum(axis=1), axis=0) * 100
                            fig = px.bar(
                                contingency_percent.reset_index().melt(id_vars=cat_var),
                                x=cat_var, y='value', color='TSA',
                                barmode='group',
                                color_discrete_map=palette,
                                labels={'value': 'Pourcentage (%)'},
                                title=f"Distribution par diagnostic"
                            )
                            fig.update_layout(height=300)  # Hauteur r√©duite
                            st.plotly_chart(fig, use_container_width=True)

                    except Exception as e:
                        st.error(f"Erreur lors du test Chi-carr√©: {str(e)}")
                else:
                    st.warning("Aucune variable cat√©gorielle trouv√©e.")

        else:  # Mann-Whitney
            st.markdown("""
            **Test de Mann-Whitney U :** Compare les distributions de deux groupes ind√©pendants.
            Un p-value < 0.05 sugg√®re une diff√©rence significative.
            """)

            numeric_cols = df.select_dtypes(include=['float', 'int']).columns.tolist()
            numeric_cols = [col for col in numeric_cols if not (col.startswith('A') and col[1:].isdigit() and len(col) <= 3)]

            if 'Score_A10' in numeric_cols:
                numeric_cols.remove('Score_A10')
                numeric_cols = ['Score_A10'] + numeric_cols

            if numeric_cols:
                num_var = st.selectbox(
                    "S√©lectionner une variable num√©rique:",
                    numeric_cols,
                    key="mw_var_selector"
                )

                try:
                    if 'TSA' in df.columns and df['TSA'].nunique() >= 2:
                        yes_group = df[df['TSA'] == 'Yes'][num_var].dropna()
                        no_group = df[df['TSA'] == 'No'][num_var].dropna()

                        if len(yes_group) > 0 and len(no_group) > 0:
                            stat, p_val = mannwhitneyu(yes_group, no_group, alternative='two-sided')

                            # Disposition compacte en 3 colonnes
                            col1, col2, col3 = st.columns([2, 2, 3])

                            with col1:
                                st.markdown("### Statistiques")
                                group_stats = df.groupby('TSA')[num_var].agg(['count', 'mean', 'std']).round(2)
                                st.dataframe(group_stats, use_container_width=True)

                            with col2:
                                st.markdown("### R√©sultats")
                                st.metric("Statistique U", f"{stat:.1f}")
                                st.metric("p-value", f"{p_val:.5f}")

                                if p_val < 0.05:
                                    st.success("**Significatif**")
                                else:
                                    st.info("**Non significatif**")

                            with col3:
                                # Box plot compact
                                fig = px.box(
                                    df.dropna(subset=[num_var]), x='TSA', y=num_var,
                                    color='TSA', color_discrete_map=palette,
                                    title=f"Comparaison {num_var}"
                                )
                                fig.update_layout(height=300)  # Hauteur r√©duite
                                st.plotly_chart(fig, use_container_width=True)
                        else:
                            st.warning("Donn√©es insuffisantes pour le test.")
                    else:
                        st.warning("Dataset doit contenir une colonne 'TSA' avec au moins deux groupes.")
                except Exception as e:
                    st.error(f"Erreur lors du test: {str(e)}")
            else:
                st.warning("Aucune variable num√©rique trouv√©e.")

    with st.expander("üìê Analyse Factorielle (FAMD)", expanded=True):
        st.markdown("""
        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="color: #2c3e50; margin-top: 0;">Analyse Factorielle Mixte (FAMD)</h3>
            <p style="color: #7f8c8d;">R√©duction de dimensions pour visualiser la structure des donn√©es et les relations entre variables.</p>
        </div>
        """, unsafe_allow_html=True)

        st.markdown("""
        L'**Analyse Factorielle de Donn√©es Mixtes (FAMD)** est une m√©thode particuli√®rement adapt√©e √† nos donn√©es car elle permet de traiter simultan√©ment:
        - Des variables num√©riques (comme l'√¢ge, les scores A1-A10)
        - Des variables cat√©gorielles (comme le genre, l'ethnie, les ant√©c√©dents familiaux)

        Cette m√©thode nous permet de projeter les donn√©es sur un plan √† deux dimensions pour visualiser les relations entre les variables et les individus.
        """)

        try:
            import prince
            from sklearn import utils
            import numpy as np

            df_famd = df.copy()
            if 'Jaunisse' in df_famd.columns:
                df_famd = df_famd.drop(columns=['Jaunisse'])
            df_famd = df_famd.reset_index(drop=True)

            class FAMD_Custom(prince.FAMD):
                """Classe personnalis√©e pour contourner le probl√®me d'indexation bool√©enne dans Prince"""
                def transform(self, X):
                    utils.validation.check_is_fitted(self, 's_')
                    return self.row_coordinates(X)

                def column_correlations_custom(self, X):
                    """M√©thode personnalis√©e pour calculer les corr√©lations des colonnes"""
                    row_pc = self.row_coordinates(X)
                    correlations = {}

                    for feature in X.columns:
                        if X[feature].dtype.kind in 'ifc':
                            corrs = []
                            for component in row_pc.columns:
                                corrs.append(np.corrcoef(X[feature], row_pc[component])[0, 1])
                            correlations[feature] = corrs

                        else:
                            means = {}
                            for component in row_pc.columns:
                                means[component] = []

                            for category in X[feature].unique():
                                mask = (X[feature] == category).values
                                for component in row_pc.columns:
                                    coord_mean = row_pc.loc[mask, component].mean()
                                    means[component].append(coord_mean)

                            max_abs = max(abs(v) for comp_means in means.values() for v in comp_means)
                            if max_abs > 0:
                                for component in means:
                                    means[component] = [v/max_abs for v in means[component]]

                            corrs = []
                            for component in row_pc.columns:
                                corrs.append(sum(means[component])/len(means[component]))
                            correlations[feature] = corrs

                    return pd.DataFrame(
                        data=[[correlations[feature][i] for feature in X.columns] for i in range(len(row_pc.columns))],
                        columns=X.columns
                    ).T

            for col in df_famd.select_dtypes(include=['object']).columns:
                df_famd[col] = df_famd[col].astype('category')

            for col in df_famd.select_dtypes(include=['number']).columns:
                df_famd[col] = df_famd[col].astype('float64')

            df_famd = df_famd.dropna()
            df_famd = df_famd.reset_index(drop=True)

            n_components = min(5, min(df_famd.shape) - 1)
            X_famd = df_famd.copy()

            famd = FAMD_Custom(
                n_components=n_components,
                n_iter=10,
                random_state=42,
                copy=True,
                engine='sklearn'
            )
            famd = famd.fit(X_famd)

            coordinates = famd.transform(X_famd)

            eigenvalues = famd.eigenvalues_
            explained_variance = eigenvalues / sum(eigenvalues)

            famd_tabs = st.tabs([
                "Projection des individus",
                "Cercle des corr√©lations",
                "FAMD score A10",
                "Cercle de corr√©lation Score A10",
                "Interpr√©tation"
            ])

            with famd_tabs[0]:
                st.subheader("Projection des individus")

                col1, col2 = st.columns([2, 1])

                with col1:
                    fig, ax = plt.subplots(figsize=(8, 5))
                    if 'TSA' in X_famd.columns:
                        coordinates_array = coordinates.values
                        for i, category in enumerate(X_famd['TSA'].unique()):
                            mask_array = (X_famd['TSA'] == category).values
                            color = "#e74c3c" if category == "Yes" else "#3498db"
                            ax.scatter(
                                coordinates_array[mask_array, 0],
                                coordinates_array[mask_array, 1],
                                label=category,
                                color=color,
                                alpha=0.6,
                                s=30
                            )
                        ax.legend(title="TSA")
                    else:
                        ax.scatter(coordinates.values[:, 0], coordinates.values[:, 1], alpha=0.7, s=30)

                    ax.set_xlabel(f'Comp. 1 ({explained_variance[0]:.1%})')
                    ax.set_ylabel(f'Comp. 2 ({explained_variance[1]:.1%})')
                    ax.set_title('Projection des individus', fontsize=12)
                    ax.grid(True, linestyle='--', alpha=0.7)
                    st.pyplot(fig)

                with col2:
                    st.markdown("### Variance expliqu√©e")
                    for i, var in enumerate(explained_variance[:3]):
                        st.metric(f"Composante {i+1}", f"{var:.1%}")

            with famd_tabs[1]:
                st.subheader("Cercle des corr√©lations")

                col1, col2 = st.columns([3, 2])

                with col1:
                    try:
                        if hasattr(famd, 'column_correlations'):
                            column_corr = famd.column_correlations(X_famd)
                        else:
                            column_corr = famd.column_correlations_custom(X_famd)

                        fig, ax = plt.subplots(figsize=(6, 6))
                        circle = plt.Circle((0, 0), 1, color='gray', fill=False, linestyle='--')
                        ax.add_artist(circle)

                        ax.axhline(y=0, color='gray', linestyle='-', alpha=0.3)
                        ax.axvline(x=0, color='gray', linestyle='-', alpha=0.3)

                        for i, var in enumerate(column_corr.index):
                            x = column_corr.iloc[i, 0]
                            y = column_corr.iloc[i, 1]

                            ax.arrow(0, 0, x, y, head_width=0.05, head_length=0.05, fc='blue', ec='blue', alpha=0.7)

                            # Texte plus petit et s√©lectif
                            if var == 'Score_A10':
                                ax.text(x*1.1, y*1.1, var, fontsize=10, color='red', fontweight='bold')
                            elif var in ['TSA', 'Age', 'Genre']:
                                ax.text(x*1.1, y*1.1, var, fontsize=8, color='green')

                        ax.set_xlim(-1.1, 1.1)
                        ax.set_ylim(-1.1, 1.1)
                        ax.set_xlabel(f'Comp. 1 ({explained_variance[0]:.1%})', fontsize=10)
                        ax.set_ylabel(f'Comp. 2 ({explained_variance[1]:.1%})', fontsize=10)
                        ax.set_title('Cercle des corr√©lations', fontsize=12)
                        ax.grid(True, linestyle='--', alpha=0.5)
                        st.pyplot(fig)

                    except Exception as e:
                        st.warning(f"Impossible de g√©n√©rer le cercle : {str(e)}")

                with col2:
                    st.markdown("### Variables principales")
                    st.write("Variables les plus contributives :")
                    key_vars = ['Score_A10', 'TSA', 'Age', 'Genre']
                    for var in key_vars:
                        if var in column_corr.index:
                            contrib = np.sqrt(column_corr.loc[var, 0]**2 + column_corr.loc[var, 1]**2)
                            st.write(f"‚Ä¢ **{var}** : {contrib:.3f}")

            with famd_tabs[2]:
                st.subheader("FAMD centr√©e sur Score A10")
                st.markdown("""
                Analyse sp√©cifique mettant en √©vidence la relation entre le Score A10 et le diagnostic TSA.
                """)

                try:
                    if 'Score_A10' in X_famd.columns:
                        a_vars_to_exclude = []
                        for i in range(1, 11):
                            col_name = f'A{i}'
                            if col_name in X_famd.columns:
                                a_vars_to_exclude.append(col_name)

                        # Cr√©er un nouveau dataframe en excluant explicitement les variables A1-A10
                        X_filtered = X_famd.drop(columns=a_vars_to_exclude, errors='ignore').copy()

                        # V√©rification que toutes les variables A1-A10 sont bien exclues
                        remaining_a_vars = [col for col in X_filtered.columns if col.startswith('A') and col[1:].isdigit()]
                        if remaining_a_vars:
                            st.warning(f"Variables A r√©siduelles : {remaining_a_vars}")
                            X_filtered = X_filtered.drop(columns=remaining_a_vars, errors='ignore')

                        # D√©finir les variables cl√©s pour l'analyse FAMD centr√©e sur Score_A10
                        key_vars = ['Score_A10', 'TSA']
                        for var in ['Age', 'Genre', 'Ethnie']:
                            if var in X_filtered.columns:
                                key_vars.append(var)

                        # Cr√©er le dataset final pour l'analyse
                        X_a10 = X_filtered[key_vars].copy()

                        famd_a10 = FAMD_Custom(
                            n_components=min(3, len(key_vars)-1),
                            n_iter=10,
                            random_state=42,
                            copy=True,
                            engine='sklearn'
                        )
                        famd_a10 = famd_a10.fit(X_a10)
                        coords_a10 = famd_a10.transform(X_a10)

                        # Disposition en colonnes comme la projection des individus
                        col1, col2 = st.columns([2, 1])

                        with col1:
                            # Cr√©ation du graphique de projection avec m√™me taille que projection individus
                            fig, ax = plt.subplots(figsize=(8, 5))
                            coords_array = coords_a10.values

                            if 'TSA' in X_a10.columns:
                                for category in X_a10['TSA'].unique():
                                    mask = (X_a10['TSA'] == category).values
                                    color = "#e74c3c" if category == "Yes" else "#3498db"
                                    ax.scatter(
                                        coords_array[mask, 0],
                                        coords_array[mask, 1],
                                        label=category,
                                        color=color,
                                        alpha=0.7,
                                        s=25
                                    )
                                ax.legend(title="TSA")

                            ax.set_xlabel('Composante 1', fontsize=10)
                            ax.set_ylabel('Composante 2', fontsize=10)
                            ax.set_title('FAMD centr√©e Score_A10', fontsize=12)
                            ax.grid(True, linestyle='--', alpha=0.7)
                            st.pyplot(fig)

                        with col2:
                            st.markdown("### Variance Score A10")
                            eigenvalues_a10 = famd_a10.eigenvalues_
                            explained_variance_a10 = eigenvalues_a10 / sum(eigenvalues_a10)
                            for i, var in enumerate(explained_variance_a10[:3]):
                                st.metric(f"Composante {i+1}", f"{var:.1%}")
                    else:
                        st.warning("La variable Score_A10 n'est pas disponible dans le dataset.")
                except Exception as e:
                    st.warning(f"Erreur lors de l'analyse FAMD : {str(e)}")

            with famd_tabs[3]:
                st.subheader("Cercle de corr√©lation Score A10")

                col1, col2 = st.columns([3, 2])

                with col1:
                    try:
                        if 'Score_A10' in X_famd.columns:
                            # Utiliser X_a10 et famd_a10 d√©finis pr√©c√©demment
                            if hasattr(famd_a10, 'column_correlations'):
                                column_corr_a10 = famd_a10.column_correlations(X_a10)
                            else:
                                st.info("Utilisation d'une m√©thode alternative pour calculer les corr√©lations...")
                                column_corr_a10 = famd_a10.column_correlations_custom(X_a10)

                            fig, ax = plt.subplots(figsize=(6, 6))
                            circle = plt.Circle((0, 0), 1, color='gray', fill=False, linestyle='--')
                            ax.add_artist(circle)

                            ax.axhline(y=0, color='gray', linestyle='-', alpha=0.3)
                            ax.axvline(x=0, color='gray', linestyle='-', alpha=0.3)

                            for i, var in enumerate(column_corr_a10.index):
                                x = column_corr_a10.iloc[i, 0]
                                y = column_corr_a10.iloc[i, 1]

                                ax.arrow(0, 0, x, y, head_width=0.05, head_length=0.05, fc='blue', ec='blue', alpha=0.7)

                                # Mise en √©vidence du Score_A10
                                if var == 'Score_A10':
                                    ax.text(x*1.1, y*1.1, var, fontsize=12, color='red', fontweight='bold')
                                else:
                                    ax.text(x*1.1, y*1.1, var, fontsize=10)

                            ax.set_xlim(-1.1, 1.1)
                            ax.set_ylim(-1.1, 1.1)
                            ax.set_xlabel(f'Composante 1', fontsize=10)
                            ax.set_ylabel(f'Composante 2', fontsize=10)
                            ax.set_title('Cercle des corr√©lations Score_A10', fontsize=12)
                            ax.grid(True, linestyle='--', alpha=0.5)
                            st.pyplot(fig)
                        else:
                            st.warning("La variable Score_A10 n'est pas disponible dans le dataset.")
                    except Exception as e:
                        st.warning(f"Impossible de g√©n√©rer le cercle des corr√©lations: {str(e)}")

                with col2:
                    st.markdown("### Analyse Score A10")
                    if 'column_corr_a10' in locals():
                        if 'Score_A10' in column_corr_a10.index:
                            score_contrib = np.sqrt(column_corr_a10.loc['Score_A10', 0]**2 + column_corr_a10.loc['Score_A10', 1]**2)
                            st.metric("Contribution Score A10", f"{score_contrib:.3f}")

                        st.markdown("**Variables corr√©l√©es :**")
                        for var in column_corr_a10.index:
                            if var != 'Score_A10':
                                contrib = np.sqrt(column_corr_a10.loc[var, 0]**2 + column_corr_a10.loc[var, 1]**2)
                                st.write(f"‚Ä¢ {var}: {contrib:.3f}")

            with famd_tabs[4]:
                st.subheader("Interpr√©tation des r√©sultats")

                col1, col2 = st.columns(2)

                with col1:
                    st.markdown("### Points cl√©s")
                    st.write(f"""
                    ‚Ä¢ **Variance expliqu√©e** : {explained_variance[0] + explained_variance[1]:.1%}
                    ‚Ä¢ **Variables discriminantes** : Score A10, TSA, Age
                    ‚Ä¢ **Regroupement TSA** : Patterns identifiables
                    """)

                with col2:
                    st.markdown("### Composantes principales")
                    summary_df = pd.DataFrame({
                        'Composante': [f"Comp. {i+1}" for i in range(min(3, len(eigenvalues)))],
                        'Variance (%)': (explained_variance[:3] * 100).round(2)
                    })
                    st.dataframe(summary_df, use_container_width=True)

                st.markdown("""
                ### Analyse d√©taill√©e

                L'analyse factorielle de donn√©es mixtes nous permet d'identifier plusieurs tendances importantes:

                1. **Structure des donn√©es** : Les deux premi√®res composantes principales expliquent environ {:.1%} de la variance totale, ce qui indique une bonne capture de la structure des donn√©es.

                2. **Variables discriminantes** : Les variables qui contribuent le plus √† la distinction entre les groupes incluent le Score A10 et d'autres variables d√©mographiques.

                3. **Regroupement des cas TSA** : On observe une tendance au regroupement des cas diagnostiqu√©s TSA dans l'espace factoriel, ce qui sugg√®re des patterns communs dans leurs profils.

                4. **Influence du Score A10** : Le Score A10 montre une corr√©lation significative avec la premi√®re composante principale, confirmant son importance dans le processus diagnostique.
                """.format(explained_variance[0] + explained_variance[1]))

                st.subheader("Tableau r√©capitulatif")
                summary_complete_df = pd.DataFrame({
                    'Composante': [f"Composante {i+1}" for i in range(len(eigenvalues))],
                    'Valeur propre': eigenvalues,
                    'Variance expliqu√©e (%)': explained_variance * 100,
                    'Variance cumul√©e (%)': np.cumsum(explained_variance) * 100
                })
                st.dataframe(summary_complete_df.style.format({
                    'Valeur propre': '{:.3f}',
                    'Variance expliqu√©e (%)': '{:.2f}%',
                    'Variance cumul√©e (%)': '{:.2f}%'
                }))

        except Exception as e:
            st.error(f"Erreur globale lors de l'analyse FAMD: {str(e)}")


def show_ml_analysis():
    import plotly.express as px
    import plotly.graph_objects as go
    from plotly.subplots import make_subplots
    import numpy as np
    import pandas as pd
    import seaborn as sns
    import matplotlib.pyplot as plt
    from sklearn.ensemble import RandomForestClassifier
    from sklearn.preprocessing import StandardScaler, OneHotEncoder
    from sklearn.compose import ColumnTransformer
    from sklearn.pipeline import Pipeline
    from sklearn.metrics import accuracy_score, precision_score, recall_score, f1_score
    from sklearn.metrics import roc_auc_score, confusion_matrix, classification_report, roc_curve
    from sklearn.metrics import balanced_accuracy_score, precision_recall_curve
    from sklearn.model_selection import cross_val_score, train_test_split, learning_curve
    import time
    import os

    # Configuration initiale
    os.environ['TQDM_DISABLE'] = '1'

    try:
        st.set_option('deprecation.showPyplotGlobalUse', False)
    except Exception:
        pass

    # Fonction d'entra√Ænement optimis√©e
    @st.cache_resource(show_spinner=False)
    def train_optimized_rf_model(_X_train, _y_train, _preprocessor, _X_test, _y_test):
        """Entra√Æne un mod√®le Random Forest optimis√© avec gestion d'erreurs"""
        try:
            rf = RandomForestClassifier(
                n_estimators=100,
                max_depth=10,
                min_samples_split=5,
                min_samples_leaf=2,
                random_state=42,
                n_jobs=-1
            )

            pipeline = Pipeline([
                ('preprocessor', _preprocessor),
                ('classifier', rf)
            ])

            start_time = time.time()
            pipeline.fit(_X_train, _y_train)
            training_time = time.time() - start_time

            # Pr√©dictions
            y_pred = pipeline.predict(_X_test)
            y_pred_proba = pipeline.predict_proba(_X_test)[:, 1]

            # M√©triques
            metrics = {
                'accuracy': accuracy_score(_y_test, y_pred),
                'precision': precision_score(_y_test, y_pred, zero_division=0),
                'recall': recall_score(_y_test, y_pred, zero_division=0),
                'f1': f1_score(_y_test, y_pred, zero_division=0),
                'auc': roc_auc_score(_y_test, y_pred_proba),
                'training_time': training_time
            }

            # Matrice de confusion
            cm = confusion_matrix(_y_test, y_pred)

            # Courbes
            fpr, tpr, _ = roc_curve(_y_test, y_pred_proba)
            precision_curve, recall_curve, _ = precision_recall_curve(_y_test, y_pred_proba)

            # Importance des features
            try:
                feature_names = pipeline.named_steps['preprocessor'].get_feature_names_out()
            except:
                feature_names = [f"feature_{i}" for i in range(len(pipeline.named_steps['classifier'].feature_importances_))]

            importances = pipeline.named_steps['classifier'].feature_importances_
            feature_importance = pd.DataFrame({
                'feature': feature_names,
                'importance': importances
            }).sort_values('importance', ascending=False)

            # Validation crois√©e
            cv_scores = cross_val_score(pipeline, _X_train, _y_train, cv=5, scoring='accuracy')

            return {
                'pipeline': pipeline,
                'metrics': metrics,
                'confusion_matrix': cm,
                'roc_curve': (fpr, tpr),
                'pr_curve': (precision_curve, recall_curve),
                'feature_importance': feature_importance,
                'cv_scores': cv_scores,
                'y_pred': y_pred,
                'y_pred_proba': y_pred_proba,
                'status': 'success'
            }

        except Exception as e:
            st.error(f"Erreur lors de l'entra√Ænement : {str(e)}")
            return {'status': 'error', 'message': str(e)}

    # Chargement et pr√©paration des donn√©es
    try:
        with st.spinner("Chargement des donn√©es..."):
            df, _, _, _, _, _, _ = load_dataset()

        # Nettoyage optimis√©
        aq_columns = [f'A{i}' for i in range(1, 11) if f'A{i}' in df.columns]
        if aq_columns:
            df = df.drop(columns=aq_columns)

        if 'Jaunisse' in df.columns:
            df = df.drop(columns=['Jaunisse'])

        if 'TSA' not in df.columns:
            st.error("‚ùå Colonne 'TSA' manquante dans le dataset")
            return

        # Pr√©paration des variables
        X = df.drop(columns=['TSA'])
        y = df['TSA'].map({'Yes': 1, 'No': 0})

        # V√©rification des donn√©es
        if X.empty or y.empty:
            st.error("‚ùå Donn√©es insuffisantes pour l'analyse")
            return

        X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.3, random_state=42, stratify=y)

    except Exception as e:
        st.error(f"‚ùå Erreur de chargement des donn√©es : {str(e)}")
        return

    # Pr√©processeur
    numerical_cols = X.select_dtypes(include=['int64', 'float64']).columns.tolist()
    categorical_cols = X.select_dtypes(include=['object', 'category']).columns.tolist()

    preprocessor = ColumnTransformer(
        transformers=[
            ('num', StandardScaler(), numerical_cols),
            ('cat', OneHotEncoder(handle_unknown='ignore'), categorical_cols)
        ],
        remainder='passthrough',
        verbose_feature_names_out=False
    )
    st.markdown("""
<div style="background: linear-gradient(90deg, #3498db, #2ecc71);
            padding: 40px 25px; border-radius: 20px; margin-bottom: 35px; text-align: center;">
    <h1 style="color: white; font-size: 2.8rem; margin-bottom: 15px;
               text-shadow: 0 2px 4px rgba(0,0,0,0.3); font-weight: 600;">
        üß† Outil de D√©pistage TSA par Machine Learning
    </h1>
    <p style="color: rgba(255,255,255,0.95); font-size: 1.3rem;
              max-width: 800px; margin: 0 auto; line-height: 1.6;">
        Une approche moderne et scientifique pour le d√©pistage pr√©coce
    </p>
</div>
""", unsafe_allow_html=True)

    st.markdown("""
    <div style="background-color: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
        <p style="font-size: 1.1rem; line-height: 1.6; text-align: center; margin: 0;">
        Cette section pr√©sente un outil d'aide au d√©pistage pr√©coce utilisant l'intelligence artificielle.
        L'objectif est d'identifier les profils √† risque n√©cessitant une √©valuation approfondie par un professionnel qualifi√©.
        </p>
    </div>
    """, unsafe_allow_html=True)

    # Onglets
    ml_tabs = st.tabs([
        "üìä Pr√©processing",
        "üöÄ Comparaison Rapide",
        "üå≤ Analyse Random Forest",
        "‚öôÔ∏è Optimisation D√©pistage"
    ])

    with ml_tabs[0]:
        st.subheader("Pipeline de pr√©traitement des donn√©es")

        st.markdown("""
        <div style="background-color: #e8f4fd; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #3498db;">
            <h3 style="color: #2c3e50; margin-top: 0;">Configuration des donn√©es pour le d√©pistage</h3>
            <p style="color: #34495e;">
            Les transformations appliqu√©es pour optimiser la d√©tection des patterns pertinents.
            </p>
        </div>
        """, unsafe_allow_html=True)

        col1, col2 = st.columns([1, 1])

        with col1:
            st.markdown("### üìã Structure du dataset")
            total_samples = len(df)
            tsa_positive = (y == 1).sum()

            st.metric("Nombre total d'√©chantillons", f"{total_samples:,}")
            st.metric("Cas √† risque d√©tect√©s", f"{tsa_positive:,} ({tsa_positive/total_samples:.1%})")

            # Distribution des classes
            fig_dist = px.pie(
                values=[tsa_positive, total_samples - tsa_positive],
                names=['TSA Positif', 'TSA N√©gatif'],
                title="R√©partition des cas",
                color_discrete_sequence=['#e74c3c', '#3498db']
            )
            st.plotly_chart(fig_dist, use_container_width=True)

        with col2:
            st.markdown("### üîß Variables analys√©es")
            preprocessing_info = pd.DataFrame({
                'Type': ['Num√©riques', 'Cat√©gorielles', 'Total'],
                'Nombre': [len(numerical_cols), len(categorical_cols), len(numerical_cols) + len(categorical_cols)],
                'Traitement': ['Standardisation', 'Encodage One-Hot', '-']
            })
            st.dataframe(preprocessing_info, use_container_width=True)

            st.markdown("#### Variables num√©riques:")
            for col in numerical_cols[:5]:  # Limiter l'affichage
                st.write(f"‚Ä¢ {col}")
            if len(numerical_cols) > 5:
                st.write(f"... et {len(numerical_cols) - 5} autres")

            st.markdown("#### Variables cat√©gorielles:")
            for col in categorical_cols[:5]:  # Limiter l'affichage
                st.write(f"‚Ä¢ {col}")
            if len(categorical_cols) > 5:
                st.write(f"... et {len(categorical_cols) - 5} autres")

    with ml_tabs[1]:
        st.subheader("Comparaison rapide des algorithmes")

        st.markdown("""
        <div style="background-color: #eaf6fc; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #3498db;">
            <h3 style="color: #2c3e50; margin-top: 0;">Crit√®res de s√©lection pour le d√©pistage</h3>
            <ul style="color: #34495e;">
                <li>ü©∫ <strong>Sensibilit√© √©lev√©e</strong> (d√©tection des vrais cas)</li>
                <li>‚ö° <strong>Rapidit√© d'ex√©cution</strong></li>
                <li>üìà <strong>Stabilit√© des r√©sultats</strong></li>
                <li>üîç <strong>Interpr√©tabilit√© clinique</strong></li>
            </ul>
        </div>
        """, unsafe_allow_html=True)

        # R√©sultats simul√©s Lazy Predict
        @st.cache_data(ttl=3600)
        def get_lazy_predict_results():
            return pd.DataFrame({
                "LGBMClassifier": {"Accuracy": 0.963, "Recall": 0.95, "F1 Score": 0.963, "Time": 0.17},
                "RandomForestClassifier": {"Accuracy": 0.956, "Recall": 0.96, "F1 Score": 0.956, "Time": 0.38},
                "XGBClassifier": {"Accuracy": 0.956, "Recall": 0.94, "F1 Score": 0.955, "Time": 0.17},
                "ExtraTreesClassifier": {"Accuracy": 0.951, "Recall": 0.93, "F1 Score": 0.951, "Time": 0.69},
                "GradientBoostingClassifier": {"Accuracy": 0.948, "Recall": 0.92, "F1 Score": 0.947, "Time": 0.52}
            }).T

        lazy_results = get_lazy_predict_results()

        # Tableau stylis√©
        def style_dataframe(df):
            return df.style.background_gradient(
                cmap='Blues',
                subset=['Accuracy', 'Recall', 'F1 Score']
            ).background_gradient(
                cmap='Blues_r',
                subset=['Time']
            ).format({
                'Accuracy': '{:.1%}',
                'Recall': '{:.1%}',
                'F1 Score': '{:.1%}',
                'Time': '{:.2f}s'
            })

        st.markdown("### üìä R√©sultats comparatifs")
        st.dataframe(style_dataframe(lazy_results), use_container_width=True)

        # Top 3 des mod√®les
        st.markdown("### üèÜ Top 3 des mod√®les pour le d√©pistage")

        top_3 = lazy_results.nlargest(3, 'Accuracy')

        col1, col2, col3 = st.columns(3)

        models_info = [
            ("LGBMClassifier", "ü•á", "#1e3a8a"),
            ("RandomForestClassifier", "ü•à", "#1e40af"),
            ("XGBClassifier", "ü•â", "#1d4ed8")
        ]

        for i, ((model_name, medal, color), col) in enumerate(zip(models_info, [col1, col2, col3])):
            if model_name in top_3.index:
                row = top_3.loc[model_name]
                with col:
                    st.markdown(f"""
                    <div style="background: linear-gradient(135deg, {color}, #60a5fa); padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                        <div style="font-size: 2rem; margin-bottom: 10px;">{medal}</div>
                        <h3 style="color: white; margin: 0; font-size: 1.1rem;">{model_name}</h3>
                        <hr style="border-color: rgba(255,255,255,0.3); margin: 15px 0;">
                        <div style="color: white;">
                            <p style="margin: 5px 0; font-size: 1.1rem;"><strong>Pr√©cision: {row['Accuracy']:.1%}</strong></p>
                            <p style="margin: 5px 0;">Sensibilit√©: {row['Recall']:.1%}</p>
                            <p style="margin: 5px 0;">F1-Score: {row['F1 Score']:.1%}</p>
                            <p style="margin: 5px 0;">Temps: {row['Time']:.2f}s</p>
                        </div>
                    </div>
                    """, unsafe_allow_html=True)

        # Graphiques comparatifs
        st.markdown("### üìà Visualisations comparatives")
        fig_scatter = px.scatter(
                lazy_results.reset_index(),
                x='Time',
                y='Accuracy',
                size='Recall',
                color='F1 Score',
                hover_name='index',
                title="Performance vs Temps d'ex√©cution",
                labels={'Time': 'Temps (secondes)', 'Accuracy': 'Pr√©cision'},
                color_continuous_scale='Blues'
            )
        fig_scatter.update_layout(height=500)
        st.plotly_chart(fig_scatter, use_container_width=True)

        st.info("""
        **üéØ Pourquoi choisir Random Forest pour le d√©pistage ?**

        - **Excellent √©quilibre** sensibilit√©/sp√©cificit√© (96% de sensibilit√©)
        - **Interpr√©tation clinique** via l'importance des caract√©ristiques
        - **Robustesse** aux donn√©es manquantes et bruit√©es
        - **Stabilit√©** des pr√©dictions sur diff√©rentes populations
        """)

    with ml_tabs[2]:
        st.header("Analyse Random Forest pour le d√©pistage")

        st.markdown("""
        <div style="background-color: #e8f5e9; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #2ecc71;">
            <h3 style="color: #2c3e50; margin-top: 0;">Configuration optimale pour le d√©pistage</h3>
            <p style="color: #34495e;">Le mod√®le Random Forest a √©t√© configur√© sp√©cifiquement pour maximiser la d√©tection des cas TSA tout en maintenant une pr√©cision √©lev√©e.</p>
        </div>
        """, unsafe_allow_html=True)

        with st.spinner("ü§ñ Entra√Ænement du mod√®le Random Forest en cours..."):
            rf_results = train_optimized_rf_model(X_train, y_train, preprocessor, X_test, y_test)

        if rf_results.get('status') != 'success':
            st.error(f"‚ùå √âchec de l'entra√Ænement : {rf_results.get('message', 'Erreur inconnue')}")
            return

        col1, col2, col3 = st.columns(3)

        with col1:
            st.metric(
                "üéØ Accuracy",
                f"{rf_results['metrics']['accuracy']:.1%}",
                "Performance globale"
            )
        with col2:
            st.metric(
                "üì° Sensibilit√©",
                f"{rf_results['metrics']['recall']:.1%}",
                "D√©tection des vrais cas"
            )
        with col3:
            st.metric(
                "üìà AUC-ROC",
                f"{rf_results['metrics']['auc']:.3f}",
                "Capacit√© discriminante"
            )

        rf_tabs = st.tabs([
            "üìä Performances d√©taill√©es",
            "üîç Matrice de confusion",
            "üìà Courbes de performance",
            "üåü Importance des variables"
        ])

        with rf_tabs[0]:
            st.subheader("üìä M√©triques de performance d√©taill√©es")

            col1, col2 = st.columns(2)

            with col1:
                metrics_df = pd.DataFrame({
                    'M√©trique': ['Accuracy', 'Precision', 'Recall', 'F1-Score', 'AUC-ROC'],
                    'Score': [
                        rf_results['metrics']['accuracy'],
                        rf_results['metrics']['precision'],
                        rf_results['metrics']['recall'],
                        rf_results['metrics']['f1'],
                        rf_results['metrics']['auc']
                    ]
                })

                fig_metrics = px.bar(
                    metrics_df,
                    x='Score',
                    y='M√©trique',
                    orientation='h',
                    title="Scores de performance",
                    color='Score',
                    color_continuous_scale='Blues'
                )
                fig_metrics.update_layout(height=400, showlegend=False)
                st.plotly_chart(fig_metrics, use_container_width=True)

            with col2:
                st.markdown("### üè• Interpr√©tation clinique")

                recall_value = rf_results['metrics']['recall']
                precision_value = rf_results['metrics']['precision']

                if recall_value >= 0.95:
                    st.success("‚úÖ **Sensibilit√© excellente** : D√©tecte 95%+ des cas TSA")
                elif recall_value >= 0.90:
                    st.info("‚ÑπÔ∏è **Sensibilit√© tr√®s bonne** : D√©tecte 90%+ des cas")
                else:
                    st.warning("‚ö†Ô∏è **Sensibilit√© √† am√©liorer** : Risque de cas manqu√©s")

                if precision_value >= 0.95:
                    st.success("‚úÖ **Pr√©cision excellente** : 95%+ des alertes sont justifi√©es")
                elif precision_value >= 0.90:
                    st.info("‚ÑπÔ∏è **Pr√©cision tr√®s bonne** : 90%+ des alertes sont fiables")
                else:
                    st.warning("‚ö†Ô∏è **Pr√©cision √† am√©liorer** : Risque de fausses alertes")

                st.metric(
                    "‚è±Ô∏è Temps d'entra√Ænement",
                    f"{rf_results['metrics']['training_time']:.2f}s",
                    "Adapt√© √† l'usage clinique"
                )

        with rf_tabs[1]:
            st.subheader("üîç Matrice de confusion")

            cm = rf_results['confusion_matrix']

            fig_cm = go.Figure(data=go.Heatmap(
                z=cm,
                x=['Pr√©dit: Non-TSA', 'Pr√©dit: TSA'],
                y=['R√©el: Non-TSA', 'R√©el: TSA'],
                colorscale='Blues',
                text=cm,
                texttemplate="%{text}",
                textfont={"size": 24, "color": "white"},
                hoverongaps=False,
                showscale=True
            ))

            fig_cm.update_layout(
                title="Matrice de confusion - Random Forest",
                xaxis_title="Pr√©diction du mod√®le",
                yaxis_title="R√©alit√© terrain",
                height=500,
                font_size=14
            )

            st.plotly_chart(fig_cm, use_container_width=True)

            if len(cm.ravel()) == 4:
                tn, fp, fn, tp = cm.ravel()

                col1, col2, col3 = st.columns(3)

                with col1:
                    st.metric("‚úÖ Vrais Positifs", tp, "Cas TSA correctement identifi√©s")
                    st.metric("‚úÖ Vrais N√©gatifs", tn, "Cas normaux correctement identifi√©s")

                with col2:
                    st.metric("‚ùå Faux Positifs", fp, "Fausses alertes")
                    st.metric("‚ùå Faux N√©gatifs", fn, "Cas TSA manqu√©s")

                with col3:
                    specificity = tn / (tn + fp) if (tn + fp) > 0 else 0
                    npv = tn / (tn + fn) if (tn + fn) > 0 else 0

                    st.metric("üéØ Sp√©cificit√©", f"{specificity:.1%}", "√âviter les fausses alertes")
                    st.metric("üõ°Ô∏è VPN", f"{npv:.1%}", "Fiabilit√© des cas n√©gatifs")

        with rf_tabs[2]:
            st.subheader("üìà Courbes de performance")

            col1, col2 = st.columns(2)

            with col1:
                fpr, tpr = rf_results['roc_curve']
                auc_score = rf_results['metrics']['auc']

                fig_roc = go.Figure()

                fig_roc.add_trace(go.Scatter(
                    x=fpr, y=tpr,
                    mode='lines',
                    name=f'Random Forest (AUC = {auc_score:.3f})',
                    line=dict(color='#e74c3c', width=3),
                    fill='tonexty'
                ))

                fig_roc.add_trace(go.Scatter(
                    x=[0, 1], y=[0, 1],
                    mode='lines',
                    name='R√©f√©rence (AUC = 0.5)',
                    line=dict(color='gray', dash='dash', width=2)
                ))

                fig_roc.update_layout(
                    title='Courbe ROC',
                    xaxis_title='Taux de Faux Positifs',
                    yaxis_title='Taux de Vrais Positifs',
                    height=400,
                    showlegend=True
                )

                st.plotly_chart(fig_roc, use_container_width=True)

            with col2:
                precision_curve, recall_curve = rf_results['pr_curve']

                fig_pr = go.Figure()

                fig_pr.add_trace(go.Scatter(
                    x=recall_curve, y=precision_curve,
                    mode='lines',
                    name='Random Forest',
                    line=dict(color='#2ecc71', width=3),
                    fill='tonexty'
                ))

                baseline_precision = (y_test == 1).mean()
                fig_pr.add_trace(go.Scatter(
                    x=[0, 1], y=[baseline_precision, baseline_precision],
                    mode='lines',
                    name=f'Baseline ({baseline_precision:.2f})',
                    line=dict(color='gray', dash='dash', width=2)
                ))

                fig_pr.update_layout(
                    title='Courbe Precision-Recall',
                    xaxis_title='Recall (Sensibilit√©)',
                    yaxis_title='Precision',
                    height=400,
                    showlegend=True
                )

                st.plotly_chart(fig_pr, use_container_width=True)

            st.subheader("üîÑ Validation crois√©e")
            cv_scores = rf_results['cv_scores']

            col1, col2 = st.columns(2)

            with col1:
                cv_metrics = {
                    'Score moyen': cv_scores.mean(),
                    '√âcart-type': cv_scores.std(),
                    'Score min': cv_scores.min(),
                    'Score max': cv_scores.max()
                }

                for metric, value in cv_metrics.items():
                    st.metric(metric, f"{value:.3f}")

            with col2:
                fig_cv = go.Figure(data=go.Bar(
                    x=[f'Fold {i+1}' for i in range(len(cv_scores))],
                    y=cv_scores,
                    marker_color='lightblue',
                    text=cv_scores,
                    texttemplate='%{text:.3f}',
                    textposition='outside'
                ))

                fig_cv.add_hline(
                    y=cv_scores.mean(),
                    line_dash="dash",
                    line_color="red",
                    annotation_text=f"Moyenne: {cv_scores.mean():.3f}"
                )

                fig_cv.update_layout(
                    title="Scores de validation crois√©e",
                    xaxis_title="Pli",
                    yaxis_title="Accuracy",
                    height=400
                )

                st.plotly_chart(fig_cv, use_container_width=True)

        with rf_tabs[3]:
            st.subheader("üåü Importance des variables")

            feature_importance = rf_results['feature_importance'].head(10)

            fig_importance = px.bar(
                feature_importance,
                x='importance',
                y='feature',
                orientation='h',
                title="Top 10 des variables les plus importantes",
                labels={'importance': 'Score d\'importance', 'feature': 'Variable'},
                color='importance',
                color_continuous_scale='Blues',
                text='importance'
            )

            fig_importance.update_traces(
                texttemplate='%{text:.3f}',
                textposition='outside'
            )
            fig_importance.update_layout(
                height=500,
                yaxis={'categoryorder': 'total ascending'},
                showlegend=False
            )

            st.plotly_chart(fig_importance, use_container_width=True)

            col1, col2 = st.columns(2)

            with col1:
                top_feature = feature_importance.iloc[0]
                st.success(f"""
                **üéØ Variable la plus importante :**

                **{top_feature['feature']}**

                - Score : {top_feature['importance']:.3f}
                - Contribution : {(top_feature['importance']/feature_importance['importance'].sum())*100:.1f}%
                """)

            with col2:
                top_5 = feature_importance.head(5)
                fig_pie = px.pie(
                    top_5,
                    values='importance',
                    names='feature',
                    title="Top 5 - R√©partition de l'influence",
                    color_discrete_sequence=px.colors.sequential.Blues_r
                )
                fig_pie.update_traces(
                    textposition='inside',
                    textinfo='percent+label',
                    textfont_size=14  
                )
                fig_pie.update_layout(
                    height=500,  #
                    showlegend=False,
                    font=dict(size=14)
                )
                st.plotly_chart(fig_pie, use_container_width=True)

    with ml_tabs[3]:
        st.header("‚öôÔ∏è Optimisation pour le d√©pistage clinique")

        st.markdown("""
        <div style="background-color: #f8f5f2; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #e67e22;">
            <h3 style="color: #2c3e50; margin-top: 0;">Adaptation au contexte clinique</h3>
            <p style="color: #34495e;">
            Personnalisation des param√®tres du mod√®le pour s'adapter aux besoins sp√©cifiques du d√©pistage TSA.
            </p>
        </div>
        """, unsafe_allow_html=True)

        if rf_results.get('status') == 'success':
            y_pred_proba = rf_results['y_pred_proba']

            st.subheader("üéØ R√©glage du seuil de d√©cision")

            col1, col2 = st.columns([2, 1])

            with col1:
                threshold = st.slider(
                    "Seuil de probabilit√© pour d√©clencher une alerte",
                    min_value=0.0,
                    max_value=1.0,
                    value=0.3,
                    step=0.05,
                    help="Plus le seuil est bas, plus le mod√®le sera sensible (d√©tectera plus de cas mais avec plus de fausses alertes)"
                )

                y_pred_adjusted = (y_pred_proba >= threshold).astype(int)
                adjusted_recall = recall_score(y_test, y_pred_adjusted)
                adjusted_precision = precision_score(y_test, y_pred_adjusted, zero_division=0)
                adjusted_f1 = f1_score(y_test, y_pred_adjusted, zero_division=0)

                met_col1, met_col2, met_col3 = st.columns(3)

                with met_col1:
                    st.metric("Sensibilit√© ajust√©e", f"{adjusted_recall:.1%}")
                with met_col2:
                    st.metric("Pr√©cision ajust√©e", f"{adjusted_precision:.1%}")
                with met_col3:
                    st.metric("F1-Score ajust√©", f"{adjusted_f1:.1%}")

            with col2:
                fig_gauge = go.Figure(go.Indicator(
                    mode = "gauge+number+delta",
                    value = adjusted_recall * 100,
                    domain = {'x': [0, 1], 'y': [0, 1]},
                    title = {'text': "Sensibilit√© (%)"},
                    delta = {'reference': recall_score(y_test, rf_results['y_pred']) * 100},
                    gauge = {
                        'axis': {'range': [0, 100]},
                        'bar': {'color': "darkblue"},
                        'steps': [
                            {'range': [0, 80], 'color': "lightgray"},
                            {'range': [80, 95], 'color': "yellow"},
                            {'range': [95, 100], 'color': "lightgreen"}
                        ],
                        'threshold': {
                            'line': {'color': "red", 'width': 4},
                            'thickness': 0.75,
                            'value': 95
                        }
                    }
                ))
                fig_gauge.update_layout(height=300)
                st.plotly_chart(fig_gauge, use_container_width=True)

            st.subheader("üìä Impact du seuil sur les performances")

            thresholds = np.linspace(0.1, 0.9, 17)
            metrics_by_threshold = []

            for t in thresholds:
                y_pred_t = (y_pred_proba >= t).astype(int)
                metrics_by_threshold.append({
                    'Seuil': t,
                    'Sensibilit√©': recall_score(y_test, y_pred_t),
                    'Pr√©cision': precision_score(y_test, y_pred_t, zero_division=0),
                    'F1-Score': f1_score(y_test, y_pred_t, zero_division=0)
                })

            df_thresholds = pd.DataFrame(metrics_by_threshold)

            fig_threshold = px.line(
                df_thresholds,
                x='Seuil',
                y=['Sensibilit√©', 'Pr√©cision', 'F1-Score'],
                title="√âvolution des m√©triques selon le seuil de d√©cision",
                labels={'value': 'Score', 'variable': 'M√©trique'},
                color_discrete_sequence=['#1f77b4', '#ff7f0e', '#2ca02c']
            )

            fig_threshold.add_vline(
                x=threshold,
                line_dash="dash",
                line_color="red",
                annotation_text=f"Seuil actuel: {threshold}"
            )

            fig_threshold.update_layout(height=400)
            st.plotly_chart(fig_threshold, use_container_width=True)

        st.subheader("üìã Protocole de d√©pistage recommand√©")

        st.markdown("""
        <div style="background: linear-gradient(90deg, #3498db, #2ecc71); padding: 20px; border-radius: 10px; color: white; margin: 20px 0;">
            <h4 style="margin: 0 0 15px 0;">üîÑ Processus de d√©pistage en 4 √©tapes</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                    <strong>1. Pr√©-d√©pistage</strong><br>
                    Application automatique du mod√®le sur questionnaire initial
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                    <strong>2. √âvaluation</strong><br>
                    Entretien structur√© si probabilit√© > 30%
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                    <strong>3. Orientation</strong><br>
                    Vers sp√©cialiste si confirmation des signaux
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                    <strong>4. Suivi</strong><br>
                    Re-test √† 6 mois pour cas n√©gatifs persistants
                </div>
            </div>
        </div>
        """, unsafe_allow_html=True)

        st.subheader("üéØ Recommandations par contexte d'utilisation")

        context_col1, context_col2, context_col3 = st.columns(3)

        with context_col1:
            st.info("""
            **üè• D√©pistage de masse**

            - Seuil recommand√© : **0.2**
            - Priorit√© : Sensibilit√© maximale
            - Objectif : Ne manquer aucun cas
            """)

        with context_col2:
            st.success("""
            **üë®‚Äç‚öïÔ∏è Consultation sp√©cialis√©e**

            - Seuil recommand√© : **0.5**
            - Priorit√© : √âquilibre optimal
            - Objectif : Aide au diagnostic
            """)

        with context_col3:
            st.warning("""
            **üî¨ Recherche clinique**

            - Seuil recommand√© : **0.7**
            - Priorit√© : Pr√©cision √©lev√©e
            - Objectif : Cohortes homog√®nes
            """)

        st.markdown("""
        <div style="margin-top: 30px; padding: 20px; border-radius: 10px; border-left: 4px solid #e74c3c; background-color: rgba(231, 76, 60, 0.1);">
            <h4 style="color: #e74c3c; margin-top: 0;">‚ö†Ô∏è Avertissement important</h4>
            <p style="font-size: 1rem; margin-bottom: 10px;">
            <strong>Ce mod√®le est un outil d'aide au d√©pistage pr√©coce et ne remplace en aucun cas :</strong>
            </p>
            <ul style="margin-left: 20px;">
                <li>Une √©valuation clinique compl√®te par un professionnel qualifi√©</li>
                <li>Les outils de diagnostic standardis√©s (ADOS, ADI-R, etc.)</li>
                <li>L'expertise clinique et l'anamn√®se d√©taill√©e</li>
            </ul>
            <p style="margin-top: 15px; font-style: italic;">
            Les r√©sultats doivent toujours √™tre interpr√©t√©s dans le contexte clinique global du patient.
            </p>
        </div>
        """, unsafe_allow_html=True)


def show_aq10_and_prediction():
    import streamlit as st
    import time
    import plotly.express as px
    import plotly.graph_objects as go

    def show_aq10_questionnaire():
        """Interface moderne et sophistiqu√©e pour le questionnaire AQ-10"""
        
        # CSS moderne pour l'interface AQ-10
        st.markdown("""
        <style>
        /* ================ Variables CSS pour AQ-10 ================ */
        :root {
            --primary-blue: #3498db;
            --secondary-green: #2ecc71;
            --accent-purple: #9b59b6;
            --warning-orange: #f39c12;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --background-light: #f8f9fa;
            --white: #ffffff;
            --shadow-soft: 0 8px 32px rgba(0,0,0,0.1);
            --shadow-medium: 0 12px 48px rgba(0,0,0,0.15);
            --border-radius: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
    
        /* ================ Container Principal AQ-10 ================ */
        .aq10-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, var(--background-light), var(--white));
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
        }
    
        /* ================ En-t√™te Questionnaire ================ */
        .aq10-header {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-green));
            padding: 40px 30px;
            border-radius: var(--border-radius);
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }
    
        .aq10-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: headerGlow 6s ease-in-out infinite alternate;
        }
    
        @keyframes headerGlow {
            0% { transform: rotate(0deg) scale(1); }
            100% { transform: rotate(360deg) scale(1.1); }
        }
    
        .aq10-title {
            color: white;
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0 0 15px 0;
            text-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
            z-index: 2;
        }
    
        .aq10-subtitle {
            color: rgba(255,255,255,0.95);
            font-size: 1.2rem;
            margin: 0;
            position: relative;
            z-index: 2;
            line-height: 1.6;
        }
    
        /* ================ Barre de Progression Moderne ================ */
        .progress-container {
            background: var(--white);
            border-radius: 25px;
            padding: 8px;
            margin: 25px 0;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
    
        .progress-bar {
            height: 12px;
            background: linear-gradient(90deg, var(--primary-blue), var(--secondary-green));
            border-radius: 20px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
    
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: progressShine 2s infinite;
        }
    
        @keyframes progressShine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
    
        .progress-text {
            text-align: center;
            margin-top: 10px;
            color: var(--text-dark);
            font-weight: 600;
            font-size: 0.95rem;
        }
    
        /* ================ Carte Question Moderne ================ */
        .question-card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 35px;
            margin: 25px 0;
            box-shadow: var(--shadow-soft);
            border: 1px solid rgba(52, 152, 219, 0.1);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
    
        .question-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
            border-color: rgba(52, 152, 219, 0.2);
        }
    
        .question-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--primary-blue), var(--secondary-green));
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
    
        .question-card:hover::before {
            transform: scaleY(1);
        }
    
        .question-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-green));
            color: white;
            border-radius: 50%;
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
    
        .question-text {
            color: var(--text-dark);
            font-size: 1.3rem;
            line-height: 1.6;
            margin: 0 0 30px 0;
            font-weight: 500;
        }
    
        /* ================ Options de R√©ponse Modernes ================ */
        .response-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }
    
        .response-option {
            background: var(--background-light);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 20px 16px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
    
        .response-option:hover {
            background: rgba(52, 152, 219, 0.05);
            border-color: rgba(52, 152, 219, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.15);
        }
    
        .response-option.selected {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-green));
            color: white;
            border-color: var(--primary-blue);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
        }
    
        .response-option input[type="radio"] {
            display: none;
        }
    
        .response-emoji {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }
    
        .response-text {
            font-weight: 600;
            font-size: 0.95rem;
            line-height: 1.4;
        }
    
        /* ================ Boutons Navigation ================ */
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 40px 0 20px 0;
            gap: 20px;
        }
    
        .nav-button {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-green));
            color: white;
            border: none;
            border-radius: 12px;
            padding: 15px 30px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            position: relative;
            overflow: hidden;
        }
    
        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
    
        .nav-button:disabled {
            background: var(--text-light);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
    
        .nav-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
    
        .nav-button:hover::before {
            left: 100%;
        }
    
        /* ================ Score Display ================ */
        .score-display {
            background: linear-gradient(135deg, var(--accent-purple), var(--warning-orange));
            color: white;
            border-radius: var(--border-radius);
            padding: 30px;
            text-align: center;
            margin: 30px 0;
            box-shadow: var(--shadow-medium);
        }
    
        .score-number {
            font-size: 4rem;
            font-weight: 800;
            margin: 0;
            text-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
    
        .score-label {
            font-size: 1.2rem;
            margin: 10px 0 0 0;
            opacity: 0.95;
        }
    
        /* ================ Animations d'Entr√©e ================ */
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
    
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    
        /* ================ Responsive Design ================ */
        @media (max-width: 768px) {
            .aq10-title {
                font-size: 2rem;
            }
            
            .response-options {
                grid-template-columns: 1fr;
            }
            
            .question-card {
                padding: 25px 20px;
            }
            
            .navigation-buttons {
                flex-direction: column;
            }
            
            .nav-button {
                width: 100%;
                margin: 5px 0;
            }
        }
        </style>
        """, unsafe_allow_html=True)
    
        # Initialisation des √©tats de session
        if 'aq10_current_question' not in st.session_state:
            st.session_state.aq10_current_question = 0
        if 'aq10_responses' not in st.session_state:
            st.session_state.aq10_responses = {}
        if 'aq10_completed' not in st.session_state:
            st.session_state.aq10_completed = False
    
        # Questions du questionnaire AQ-10
        questions = {
            1: "Je remarque souvent de petits bruits que les autres ne remarquent pas.",
            2: "Je me concentre g√©n√©ralement davantage sur l'ensemble que sur les petits d√©tails.",
            3: "Je trouve facile de faire plusieurs choses en m√™me temps.",
            4: "S'il y a une interruption, je peux rapidement reprendre ce que je faisais.",
            5: "Je trouve facile de ¬´ lire entre les lignes ¬ª quand quelqu'un me parle.",
            6: "Je sais comment savoir si la personne qui m'√©coute commence √† s'ennuyer.",
            7: "Quand je lis une histoire, j'ai du mal √† comprendre les intentions des personnages.",
            8: "J'aime collecter des informations sur des cat√©gories de choses (par exemple : types de voitures, d'oiseaux, de trains, de plantes, etc.).",
            9: "Je trouve facile de comprendre ce que quelqu'un pense ou ressent rien qu'en regardant son visage.",
            10: "J'ai du mal √† comprendre les intentions des gens."
        }
    
        # Options de r√©ponse avec √©mojis
        response_options = {
            "Tout √† fait d'accord": {"emoji": "üíØ", "value": 1},
            "Plut√¥t d'accord": {"emoji": "üëç", "value": 1}, 
            "Plut√¥t pas d'accord": {"emoji": "üëé", "value": 0},
            "Pas du tout d'accord": {"emoji": "‚ùå", "value": 0}
        }
    
        # En-t√™te principal
        st.markdown("""
        <div class="aq10-container">
            <div class="aq10-header fade-in">
                <h1 class="aq10-title">üß© Questionnaire AQ-10</h1>
                <p class="aq10-subtitle">
                    Un outil de d√©pistage moderne et interactif pour l'√©valuation 
                    des traits du spectre autistique
                </p>
            </div>
        """, unsafe_allow_html=True)
    
        # Barre de progression
        progress = (len(st.session_state.aq10_responses) / 10) * 100
        st.markdown(f"""
            <div class="progress-container">
                <div class="progress-bar" style="width: {progress}%"></div>
            </div>
            <div class="progress-text">
                Question {len(st.session_state.aq10_responses)} / 10 compl√©t√©es 
                ({progress:.0f}%)
            </div>
        """, unsafe_allow_html=True)
    
        # Affichage des questions ou r√©sultats
        if not st.session_state.aq10_completed:
            show_current_question(questions, response_options)
        else:
            show_results()
    
        st.markdown("</div>", unsafe_allow_html=True)
    
    def show_current_question(questions, response_options):
        """Affiche la question actuelle avec une interface moderne"""
        
        current_q = st.session_state.aq10_current_question + 1
        
        if current_q <= 10:
            question_text = questions[current_q]
            
            # Carte de question avec animation
            st.markdown(f"""
            <div class="question-card fade-in">
                <div class="question-number">{current_q}</div>
                <div class="question-text">{question_text}</div>
            </div>
            """, unsafe_allow_html=True)
    
            # Interface de r√©ponse moderne
            st.markdown('<div class="response-options">', unsafe_allow_html=True)
            
            # Cr√©er les colonnes pour les options
            cols = st.columns(4)
            
            selected_response = st.session_state.aq10_responses.get(current_q)
            
            for i, (option_text, option_data) in enumerate(response_options.items()):
                with cols[i]:
                    # CSS class pour l'option s√©lectionn√©e
                    selected_class = "selected" if selected_response == option_text else ""
                    
                    if st.button(
                        f"{option_data['emoji']}\n{option_text}",
                        key=f"q{current_q}_option_{i}",
                        help=f"S√©lectionner : {option_text}"
                    ):
                        st.session_state.aq10_responses[current_q] = option_text
                        st.rerun()
    
            st.markdown('</div>', unsafe_allow_html=True)
    
            # Boutons de navigation
            show_navigation_buttons()
        else:
            # Toutes les questions sont termin√©es
            st.session_state.aq10_completed = True
            st.rerun()
    
    def show_navigation_buttons():
        """Affiche les boutons de navigation avec design moderne"""
        
        st.markdown('<div class="navigation-buttons">', unsafe_allow_html=True)
        
        col1, col2, col3 = st.columns([1, 2, 1])
        
        with col1:
            if st.session_state.aq10_current_question > 0:
                if st.button("‚¨ÖÔ∏è Pr√©c√©dent", key="prev_btn"):
                    st.session_state.aq10_current_question -= 1
                    st.rerun()
        
        with col2:
            # Indicateur de progression central
            completed = len(st.session_state.aq10_responses)
            st.markdown(f"""
            <div style="text-align: center; color: var(--text-dark); font-weight: 600;">
                üìã {completed}/10 questions r√©pondues
            </div>
            """, unsafe_allow_html=True)
        
        with col3:
            current_q = st.session_state.aq10_current_question + 1
            
            # Bouton suivant ou terminer
            if current_q in st.session_state.aq10_responses:
                if current_q < 10:
                    if st.button("Suivant ‚û°Ô∏è", key="next_btn"):
                        st.session_state.aq10_current_question += 1
                        st.rerun()
                else:
                    if st.button("üèÅ Terminer", key="finish_btn"):
                        st.session_state.aq10_completed = True
                        st.rerun()
        
        st.markdown('</div>', unsafe_allow_html=True)
    
    def show_results():
        """Affiche les r√©sultats avec visualisations modernes"""
        
        # Calcul du score
        score_mapping = {
            "Tout √† fait d'accord": 1,
            "Plut√¥t d'accord": 1,
            "Plut√¥t pas d'accord": 0,
            "Pas du tout d'accord": 0
        }
        
        # Questions qui sont invers√©es (score 0 = r√©ponse positive pour TSA)
        reversed_questions = [2, 3, 4, 5, 6, 9]
        
        total_score = 0
        for q_num, response in st.session_state.aq10_responses.items():
            base_score = score_mapping[response]
            if q_num in reversed_questions:
                total_score += 1 - base_score
            else:
                total_score += base_score
    
        # Affichage du score avec design moderne
        st.markdown(f"""
        <div class="score-display fade-in">
            <div class="score-number">{total_score}</div>
            <div class="score-label">Score AQ-10 sur 10</div>
        </div>
        """, unsafe_allow_html=True)
    
        # Interpr√©tation des r√©sultats
        show_score_interpretation(total_score)
        
        # Visualisation des r√©ponses
        show_response_visualization()
        
        # Boutons d'action
        show_action_buttons()
    
    def show_score_interpretation(score):
        """Affiche l'interpr√©tation du score avec design moderne"""
        
        if score >= 6:
            interpretation = {
                "level": "√âlev√©",
                "color": "#e74c3c",
                "icon": "üö®",
                "message": "Score sugg√©rant la pr√©sence de traits autistiques significatifs",
                "recommendation": "Il est recommand√© de consulter un professionnel de sant√© sp√©cialis√© pour une √©valuation plus approfondie."
            }
        elif score >= 4:
            interpretation = {
                "level": "Mod√©r√©", 
                "color": "#f39c12",
                "icon": "‚ö†Ô∏è",
                "message": "Score interm√©diaire n√©cessitant une attention particuli√®re",
                "recommendation": "Une surveillance ou une consultation pr√©ventive pourrait √™tre b√©n√©fique."
            }
        else:
            interpretation = {
                "level": "Faible",
                "color": "#27ae60", 
                "icon": "‚úÖ",
                "message": "Score dans la fourchette typique",
                "recommendation": "Les r√©ponses ne sugg√®rent pas de traits autistiques marqu√©s."
            }
    
        st.markdown(f"""
        <div style="background: linear-gradient(135deg, {interpretation['color']}, {interpretation['color']}dd); 
                    color: white; border-radius: 16px; padding: 30px; margin: 25px 0; 
                    box-shadow: 0 8px 32px rgba(0,0,0,0.15);">
            <div style="text-align: center;">
                <div style="font-size: 3rem; margin-bottom: 15px;">{interpretation['icon']}</div>
                <h3 style="margin: 0 0 15px 0; font-size: 1.8rem;">Niveau {interpretation['level']}</h3>
                <p style="font-size: 1.2rem; margin: 0 0 20px 0; line-height: 1.6;">
                    {interpretation['message']}
                </p>
                <div style="background: rgba(255,255,255,0.2); border-radius: 12px; padding: 20px;">
                    <p style="margin: 0; font-size: 1.1rem; line-height: 1.6;">
                        <strong>Recommandation :</strong> {interpretation['recommendation']}
                    </p>
                </div>
            </div>
        </div>
        """, unsafe_allow_html=True)
    
    def show_response_visualization():
        """Affiche une visualisation moderne des r√©ponses"""
        
        st.subheader("üìä Analyse d√©taill√©e de vos r√©ponses")
        
        # Pr√©paration des donn√©es pour la visualisation
        responses_data = []
        for q_num, response in st.session_state.aq10_responses.items():
            responses_data.append({
                'Question': f'Q{q_num}',
                'R√©ponse': response,
                'Niveau': 'Accord' if 'accord' in response.lower() and 'pas' not in response.lower() else 'D√©saccord'
            })
        
        import pandas as pd
        df_responses = pd.DataFrame(responses_data)
        
        # Graphique en secteurs moderne
        fig_pie = px.pie(
            df_responses, 
            names='Niveau',
            title="R√©partition de vos r√©ponses",
            color_discrete_sequence=['#3498db', '#e74c3c']
        )
        fig_pie.update_traces(
            textposition='inside', 
            textinfo='percent+label',
            hovertemplate='<b>%{label}</b><br>%{value} r√©ponses<br>%{percent}<extra></extra>'
        )
        fig_pie.update_layout(
            font_size=14,
            height=400,
            showlegend=True
        )
        
        st.plotly_chart(fig_pie, use_container_width=True)
        
        # Graphique en barres par question
        response_mapping = {
            "Tout √† fait d'accord": 4,
            "Plut√¥t d'accord": 3,
            "Plut√¥t pas d'accord": 2, 
            "Pas du tout d'accord": 1
        }
        
        df_responses['Score_Num√©rique'] = df_responses['R√©ponse'].map(response_mapping)
        
        fig_bar = px.bar(
            df_responses,
            x='Question',
            y='Score_Num√©rique',
            color='Score_Num√©rique',
            title="Intensit√© des r√©ponses par question",
            color_continuous_scale='Blues',
            labels={'Score_Num√©rique': 'Niveau d\'accord (1-4)'}
        )
        fig_bar.update_layout(
            height=400,
            showlegend=False
        )
        
        st.plotly_chart(fig_bar, use_container_width=True)
    
    def show_action_buttons():
        """Affiche les boutons d'action avec design moderne"""
        
        st.markdown("### üéØ Prochaines √©tapes")
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            if st.button("üîÑ Recommencer le test", key="restart_btn"):
                # R√©initialiser toutes les variables de session
                for key in ['aq10_current_question', 'aq10_responses', 'aq10_completed']:
                    if key in st.session_state:
                        del st.session_state[key]
                st.rerun()
        
        with col2:
            if st.button("üìÑ T√©l√©charger les r√©sultats", key="download_btn"):
                # Fonction de t√©l√©chargement (√† impl√©menter)
                st.success("Fonctionnalit√© de t√©l√©chargement en cours de d√©veloppement")
        
        with col3:
            if st.button("ü©∫ Trouver un sp√©cialiste", key="specialist_btn"):
                # Redirection vers ressources (√† impl√©menter)
                st.info("Redirection vers les ressources sp√©cialis√©es")
    
    # Int√©gration dans l'application principale
    def integrate_aq10_in_prediction():
        """Int√®gre le questionnaire AQ-10 moderne dans la section pr√©diction"""
        
        st.markdown("""
        <div style="background: linear-gradient(90deg, #3498db, #2ecc71);
                    padding: 40px 25px; border-radius: 20px; margin-bottom: 35px; text-align: center;">
            <h1 style="color: white; font-size: 2.8rem; margin-bottom: 15px;
                       text-shadow: 0 2px 4px rgba(0,0,0,0.3); font-weight: 600;">
                ü§ñ Pr√©diction par Intelligence Artificielle
            </h1>
            <p style="color: rgba(255,255,255,0.95); font-size: 1.3rem;
                      max-width: 800px; margin: 0 auto; line-height: 1.6;">
                √âvaluation moderne avec le questionnaire AQ-10 interactif
            </p>
        </div>
        """, unsafe_allow_html=True)
        
        # Onglets pour diff√©rentes approches
        tabs = st.tabs([
            "üìù Questionnaire AQ-10 Moderne",
            "üî¨ Analyse Pr√©dictive", 
            "üìä Tableau de Bord"
        ])
        
        with tabs[0]:
            show_aq10_questionnaire()
        
        with tabs[1]:
            st.info("Section d'analyse pr√©dictive bas√©e sur les r√©ponses AQ-10")
            # Int√©grer ici l'analyse ML bas√©e sur les r√©ponses
        
        with tabs[2]:
            st.info("Tableau de bord avec m√©triques et insights")
            # Affichage des statistiques globales


def show_about_page():
    st.markdown("""
    <div style="background: linear-gradient(90deg, #3498db, #2ecc71); 
                padding: 40px 20px; border-radius: 20px; margin-bottom: 30px; text-align: center;">
        <h1 style="color: white; font-size: 2.8rem; margin-bottom: 15px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
            ‚ÑπÔ∏è √Ä propos du Projet
        </h1>
        <p style="color: rgba(255,255,255,0.9); font-size: 1.3rem; max-width: 800px; margin: 0 auto; line-height: 1.6;">
            Une initiative innovante pour am√©liorer le d√©pistage pr√©coce des Troubles du Spectre Autistique
        </p>
    </div>
    """, unsafe_allow_html=True)



    image_url = "https://drive.google.com/file/d/1tbARR43xi1GCnfY9XrEc-O2FbMnTmPcW/view?usp=sharing"
    st.markdown(get_img_with_href(image_url, "#", as_banner=False), unsafe_allow_html=True)

    st.markdown("""
    <div style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); 
                padding: 30px; border-radius: 15px; margin-bottom: 30px;">
        <h2 style="color: #2c3e50; text-align: center; margin-bottom: 25px; font-size: 2.2rem;">
            üéØ Contexte du Projet
        </h2>
        <div style="max-width: 900px; margin: 0 auto;">
            <p style="font-size: 1.1rem; line-height: 1.8; text-align: justify; margin-bottom: 20px; color: #34495e;">
                Ce projet a √©t√© d√©velopp√© dans le cadre d'une √©tude approfondie sur les m√©thodes de d√©pistage 
                des Troubles du Spectre Autistique (TSA). Notre approche combine l'analyse de donn√©es massives, 
                l'intelligence artificielle et l'expertise clinique pour cr√©er un outil d'aide au diagnostic pr√©coce.
            </p>
            <p style="font-size: 1.1rem; line-height: 1.8; text-align: justify; color: #34495e;">
                L'objectif principal est de faciliter l'identification pr√©coce des signaux d'alerte, permettant 
                ainsi une intervention plus rapide et plus efficace pour les personnes concern√©es et leurs familles.
            </p>
        </div>
    </div>
    """, unsafe_allow_html=True)

    st.markdown("## üéØ Objectifs du Projet")
    
    col1, col2, col3 = st.columns(3)
    
    objectives = [
        {
            "icon": "üîç",
            "title": "Identifier les facteurs",
            "description": "Analyser les variables associ√©es √† la pr√©sence d'un TSA √† partir de donn√©es multiples",
            "color": "#3498db"
        },
        {
            "icon": "üìä",
            "title": "Explorer les donn√©es",
            "description": "D√©couvrir des tendances et biais dans les jeux de donn√©es internationaux",
            "color": "#2ecc71"
        },
        {
            "icon": "ü§ñ",
            "title": "Construire des mod√®les",
            "description": "D√©velopper des outils pr√©dictifs pour l'aide √† l'√©valuation du TSA",
            "color": "#9b59b6"
        }
    ]
    
    for i, (obj, col) in enumerate(zip(objectives, [col1, col2, col3])):
        with col:
            st.markdown(f"""
            <div style="background: linear-gradient(135deg, {obj['color']}, {obj['color']}cc); 
                        color: white; padding: 25px; border-radius: 15px; height: 280px; 
                        box-shadow: 0 8px 25px rgba(0,0,0,0.15); transition: transform 0.3s ease;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 3rem; margin-bottom: 15px;">{obj['icon']}</div>
                    <h3 style="margin: 0; font-size: 1.4rem; font-weight: 600;">{obj['title']}</h3>
                </div>
                <p style="font-size: 1rem; line-height: 1.5; text-align: center; margin: 0;">
                    {obj['description']}
                </p>
            </div>
            """, unsafe_allow_html=True)

    st.markdown("""
    <div style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); 
                padding: 30px; border-radius: 15px; margin: 30px 0;">
        <h2 style="color: #8b4513; text-align: center; margin-bottom: 25px; font-size: 2.2rem;">
            üìö Sources de Donn√©es
        </h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
                    gap: 20px; max-width: 1000px; margin: 0 auto;">
            <div style="background: rgba(255,255,255,0.8); padding: 20px; border-radius: 10px;">
                <h4 style="color: #8b4513; margin-bottom: 10px;">üåç Couverture Internationale</h4>
                <p style="margin: 0; color: #5d4e37;">Plus de 5000 participants de diff√©rentes origines g√©ographiques</p>
            </div>
            <div style="background: rgba(255,255,255,0.8); padding: 20px; border-radius: 10px;">
                <h4 style="color: #8b4513; margin-bottom: 10px;">üìä Donn√©es Diversifi√©es</h4>
                <p style="margin: 0; color: #5d4e37;">5 jeux de donn√©es publics combin√©s et harmonis√©s</p>
            </div>
        </div>
    </div>
    """, unsafe_allow_html=True)

    st.markdown("""
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                padding: 30px; border-radius: 15px; margin: 30px 0;">
        <h2 style="color: white; text-align: center; margin-bottom: 25px; font-size: 2.2rem;">
            üë• √âquipe du Projet
        </h2>
        <div style="max-width: 1000px; margin: 0 auto;">
            <p style="font-size: 1.2rem; line-height: 1.6; color: rgba(255,255,255,0.9); text-align: center; margin-bottom: 30px;">
                Ce projet a √©t√© r√©alis√© par une √©quipe de futurs data analysts passionn√©s par l'innovation en sant√© digitale.
            </p>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px;">
                <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; 
                            text-align: center; backdrop-filter: blur(10px); 
                            display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <div style="font-size: 2.5rem; margin-bottom: 10px;">üë®‚Äçüíª</div>
                    <h4 style="color: white; margin: 0; font-size: 1.2rem; text-align: center; 
                               display: flex; align-items: center; justify-content: center; height: auto;">
                        R√©mi CHENOURI
                    </h4>
                    <p style="color: rgba(255,255,255,0.8); margin: 5px 0 0 0; font-size: 0.9rem; 
                              text-align: center;">Futur Data Analyst</p>
                </div>
                <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; 
                            text-align: center; backdrop-filter: blur(10px); 
                            display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <div style="font-size: 2.5rem; margin-bottom: 10px;">üë©‚Äçüíª</div>
                    <h4 style="color: white; margin: 0; font-size: 1.2rem; text-align: center; 
                               display: flex; align-items: center; justify-content: center; height: auto;">
                        Alexandre BERNARD
                    </h4>
                    <p style="color: rgba(255,255,255,0.8); margin: 5px 0 0 0; font-size: 0.9rem; 
                              text-align: center;">Futur Data Analyst</p>
                </div>
                <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; 
                            text-align: center; backdrop-filter: blur(10px); 
                            display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <div style="font-size: 2.5rem; margin-bottom: 10px;">üë®‚Äçüíª</div>
                    <h4 style="color: white; margin: 0; font-size: 1.2rem; text-align: center; 
                               display: flex; align-items: center; justify-content: center; height: auto;">
                        Laurence SOUPPARAZAYA
                    </h4>
                    <p style="color: rgba(255,255,255,0.8); margin: 5px 0 0 0; font-size: 0.9rem; 
                              text-align: center;">Future Data Analyst</p>
                </div>
                <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; 
                            text-align: center; backdrop-filter: blur(10px); 
                            display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <div style="font-size: 2.5rem; margin-bottom: 10px;">üë©‚Äçüíª</div>
                    <h4 style="color: white; margin: 0; font-size: 1.2rem; text-align: center; 
                               display: flex; align-items: center; justify-content: center; height: auto;">
                        Ahmed IBNABASSE
                    </h4>
                    <p style="color: rgba(255,255,255,0.8); margin: 5px 0 0 0; font-size: 0.9rem; 
                              text-align: center;">Future Data Analyst</p>
                </div>
            </div>
        </div>
    </div>
    """, unsafe_allow_html=True)

    st.markdown("""
    <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); 
                padding: 30px; border-radius: 15px; margin: 30px 0;">
        <h2 style="color: #2c3e50; text-align: center; margin-bottom: 20px; font-size: 2.2rem;">
            üôè Remerciements
        </h2>
        <div style="text-align: center; max-width: 700px; margin: 0 auto;">
            <p style="font-size: 1.2rem; line-height: 1.7; color: #2c3e50; margin-bottom: 15px;">
                Nous remercions toutes les personnes ayant contribu√© √† ce projet, en particulier 
                <strong>notre mentor Yohan Cohen</strong> pour son soutien et ses conseils pr√©cieux 
                tout au long de cette recherche.
            </p>
            <p style="font-size: 1.1rem; color: #34495e; font-style: italic;">
                Un remerciement sp√©cial √† toutes les familles et individus qui ont particip√© aux √©tudes 
                ayant permis la constitution de ces jeux de donn√©es.
            </p>
        </div>
    </div>
    """, unsafe_allow_html=True)

    st.markdown("""
    <div style="background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%); 
                padding: 25px; border-radius: 15px; margin: 30px 0;">
        <h2 style="color: #8b4513; text-align: center; margin-bottom: 20px; font-size: 2rem;">
            üìÑ Licence et Utilisation
        </h2>
        <div style="text-align: center; max-width: 800px; margin: 0 auto;">
            <p style="font-size: 1.1rem; line-height: 1.6; color: #5d4e37;">
                Cette application est mise √† disposition sous licence open-source. 
                Le code et les donn√©es anonymis√©es sont disponibles pour des fins de recherche uniquement.
            </p>
        </div>
    </div>
    """, unsafe_allow_html=True)

    st.markdown("""
    <div style="border: 2px solid #e74c3c; border-radius: 10px; padding: 20px; 
                background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); margin-top: 30px;">
        <h3 style="color: #c62828; margin-top: 0; text-align: center;">
            ‚ö†Ô∏è Avertissement Important
        </h3>
        <p style="font-size: 1rem; color: #b71c1c; text-align: center; margin: 0; font-weight: 500;">
            Cette application est un outil d'aide au d√©pistage pr√©coce et ne remplace en aucun cas 
            une √©valuation clinique compl√®te par un professionnel de sant√© qualifi√©.
        </p>
    </div>
    """, unsafe_allow_html=True)

    pass

def main():
    if "initialized" not in st.session_state:
        set_custom_theme()
        st.session_state.initialized = True

        if "aq10_total" not in st.session_state:
            st.session_state.aq10_total = 0

        if "expanders_initialized" not in st.session_state:
            st.session_state.expanders_initialized = {
                'structure': True,
                'valeurs_manquantes': False,
                'pipeline': False,
                'variables_cles': True,
                'questionnaire': False,
                'composite': False,
                'statistiques': False,
                'correlation': False,
                'famd': False
            }

    if 'df' not in st.session_state:
        with st.spinner("Chargement des donn√©es..."):
            st.session_state.df, st.session_state.df_ds1, st.session_state.df_ds2, st.session_state.df_ds3, st.session_state.df_ds4, st.session_state.df_ds5, st.session_state.df_stats = load_dataset()

    with st.sidebar:
        st.markdown('<p class="sidebar-title">üß© Autisme - Navigation</p>', unsafe_allow_html=True)
        pages = [
            "üè† Accueil",
            "üîç Exploration",
            "üß† Analyse ML",
            "ü§ñ Pr√©diction par IA",
            "üìö Documentation",
            "‚ÑπÔ∏è √Ä propos"
        ]
        selection = st.sidebar.radio("Choisissez un outil :", pages)

    palette = {
        "Yes": "#3498db",
        "No": "#2ecc71",
        "Unknown": "#95a5a6"
    }

    if "üè† Accueil" in selection:
        show_home_page()
    elif "üîç Exploration" in selection:
        show_data_exploration()
    elif "üß† Analyse ML" in selection:
        show_ml_analysis()
    elif "ü§ñ Pr√©diction par IA" in selection:
        show_aq10_and_prediction()
    elif "üìö Documentation" in selection:
        show_documentation()
    elif "‚ÑπÔ∏è √Ä propos" in selection:
        show_about_page()

if __name__ == "__main__":
    main()


